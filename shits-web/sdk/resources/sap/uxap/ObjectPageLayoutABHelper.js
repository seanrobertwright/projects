/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Metadata","sap/ui/core/Core","sap/ui/core/CustomData","sap/ui/core/Configuration","sap/ui/base/ManagedObjectObserver","./AnchorBar","sap/m/Button","sap/m/MenuButton","sap/m/Menu","sap/m/MenuItem","sap/ui/core/IconPool"],function(q,M,C,a,b,c,A,B,d,e,f,I){"use strict";var S=[b.AnimationMode.full,b.AnimationMode.basic];var g=M.createClass("sap.uxap._helpers.AB",{constructor:function(o){this._oObjectPageLayout=o;this._iScrollDuration=o._iScrollToSectionDuration;this._iFocusMoveDelay=this._iScrollDuration-100;this._oObserver=new c(this._proxyStateChanges.bind(this));this._aMenusWithAttachPressHandler=[];}});g.prototype.getObjectPageLayout=function(){return this._oObjectPageLayout;};g.prototype._proxyStateChanges=function(o){var O=o.object,i=this._findExistingClone(O),p=o.name,v=o.current,s="set"+h(p);if(i){i[s].call(i,v);}};g.prototype._findExistingClone=function(o){var i,s=o.getId()+"-__clone",j=this._getAnchorBar(),k=j.getContent();k.some(function(l){if(l.getId().indexOf(s)===0){i=l;return true;}});return i;};g.prototype._getAnchorBar=function(){var o=this.getObjectPageLayout(),i=o.getAggregation("_anchorBar");if(!i){i=new A({id:o.getId()+"-anchBar",showPopover:o.getShowAnchorBarPopover(),backgroundDesign:o.getBackgroundDesignAnchorBar()});this.getObjectPageLayout().setAggregation("_anchorBar",i,true);}return i;};g.prototype._setCustomData=function(o,s,O,i){O._oSectionInfo[s.getId()].buttonId=o.getId();o.addCustomData(new a({key:"sectionId",value:s.getId()}));o.addCustomData(new a({key:"bTitleVisible",value:s._getInternalTitleVisible()}));if(!i){o.addCustomData(new a({key:"secondLevel",value:true}));}};g.prototype._buildAnchorBar=function(){var o=this.getObjectPageLayout(),s=o.getSections()||[],i=this._getAnchorBar(),p=q.proxy(i._handleDirectScroll,i),j,k,m,l;if(i&&this.getObjectPageLayout().getShowAnchorBar()){i._resetControl();this._oObserver.disconnect();s.forEach(function(n){if(!n.getVisible()||!n._getInternalVisible()){return;}var r,t=n.getSubSections()||[];r=this._buildAnchorBarButton(n,true);if(r){i.addContent(r);if(r instanceof d){var u=new e({}),R=sap.ui.getCore().getLibraryResourceBundle("sap.uxap");r.enhanceAccessibilityState=function(E,v){var w=i.getContent(),x=w.indexOf(E.getParent());if(x!==-1){v.role="menuitemradio";v.roledescription=R.getText("ANCHOR_BAR_MENUITEM");v.setsize=w.length;v.posinset=x+1;}};u._setCustomEnhanceAccStateFunction(function(E,v){v.controls=E.data("sectionId");});r.setMenu(u);}t.forEach(function(v){if(!v.getVisible()||!v._getInternalVisible()){return;}var w=this._buildAnchorBarButton(v,false),x=i.getId()+"-"+v.getId()+"-anchor";if(w){i.addContent(w);}if(r instanceof d){l=v.getCustomAnchorBarButton();if(l){j=l.getText();k=l.getIcon();}else{j=v._getInternalTitle()||v.getTitle();k='';}m=new f(x,{"text":j,"icon":k});m.addCustomData(new a({key:"sectionId",value:v.getId()}));m.attachPress(p);this._setCustomData(m,v,o,false);r.getMenu().addItem(m);}},this);}},this);}};g.prototype._moveFocusOnSection=function(s){var o=s.data(),i=sap.ui.getCore().byId(o.sectionId),O=this.getObjectPageLayout(),j=i.isA("sap.uxap.ObjectPageSubSection"),k=(i&&!O.getUseIconTabBar())||(O.getUseIconTabBar()&&j),F=this._iFocusMoveDelay;if(k&&this._isScrollAnimationEnabled()){setTimeout(i.$()["focus"].bind(i.$()),F);}else if(k){i.$().focus();}if(O.getUseIconTabBar()&&j){var D={"onAfterRendering":function(){this.removeEventDelegate(D);setTimeout(this.$()["focus"].bind(this.$()),F);}.bind(i)};i.addEventDelegate(D);}};g.prototype._isScrollAnimationEnabled=function(){return S.indexOf(C.getConfiguration().getAnimationMode())>=0;};g.prototype._instantiateAnchorBarButton=function(i,s,j){var k,o;if(i){k=d;o={type:"Transparent",buttonMode:"Split",useDefaultActionOnly:true,ariaDescribedBy:s};}else{k=B;o={ariaDescribedBy:s};}if(j){o.id=j;}return new k(o);};g.prototype._buildAnchorBarButton=function(s,i){var o=null,O=this.getObjectPageLayout(),j,k=this._getAnchorBar(),l,m,H,v,n=s.getAggregation("subSections"),p=q.proxy(k._handleDirectScroll,k);if(s.getVisible()&&s._getInternalVisible()){j=s.getCustomAnchorBarButton();if(!j){l=k.getId()+"-"+s.getId()+"-anchor";if(i){if(n&&n.length>1){v=n.filter(function(r){return r.getVisible()&&r._getInternalVisible();}).length;}}H=i&&v>1&&k.getShowPopover();if(H){o=this._instantiateAnchorBarButton(true,s,l);o.attachDefaultAction(p);o._getButtonControl().attachPress(function(){this.getParent().focus();});o._getButtonControl().attachArrowPress(function(){var r=o._getButtonControl();if(this._aMenusWithAttachPressHandler[r.getId()]){return;}o.getMenu().attachItemSelected(function(E){this._moveFocusOnSection(E.getParameter("item"));},this);this._aMenusWithAttachPressHandler[r.getId()]=true;},this);o.addCustomData(new a({key:"bHasSubMenu",value:true}));}else if(i){o=this._instantiateAnchorBarButton(false,s,l);o.attachPress(function(E){this._moveFocusOnSection(E.getSource());},this);o.attachPress(p);}else{m=k.getId()+"-"+s.getId()+"-sub-anchor";o=this._instantiateAnchorBarButton(false,s,m);}var t=(s._getInternalTitle()!="")?s._getInternalTitle():s.getTitle();o.setText(t);}else{o=j.clone();o.attachPress(function(E){this._moveFocusOnSection(E.getSource());},this);o.attachPress(p);this._oObserver.observe(j,{properties:true});}this._setCustomData(o,s,O,i);}return o;};function h(n){return n.substring(0,1).toUpperCase()+n.substring(1);}return g;});

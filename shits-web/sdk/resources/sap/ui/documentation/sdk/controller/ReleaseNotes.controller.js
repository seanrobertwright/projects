/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/documentation/sdk/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/documentation/library","sap/base/util/Version","sap/base/Log"],function(q,B,J,l,V,L){"use strict";var n="neo-app.json",s="resources/sap-ui-version.json";return B.extend("sap.ui.documentation.sdk.controller.ReleaseNotes",{onInit:function(){this._oView=this.getView();this._requestResources();this._resourceAvailabilityHandler();this._oModel=new J();this._oVersionModel=new J();this._oView.setModel(this._oModel);this._oView.setModel(this._oVersionModel,"select");l._getAppInfo(this._processAppInfo.bind(this));},_processAppInfo:function(a){var v,m,M,b,o;if(!(a)){return;}v=V(a.version);m=v.getMajor();M=v.getMinor();if(v.getSuffix()!==""){if(M%2!==0){M=(M+1);}}b=m+"."+M;this._updateVersionInformation(b);o={items:[]};while(M>=28){b=m+"."+M;o.items.push({key:b,value:b});M=M-(M<=60?2:1);}this._oVersionModel.setData(o);},_processLibInfo:function(c,o){var r,R=[],d=c.length,p,i;p=function(v,e){r+=e.notes.length;c[i].versions.push({version:v,notes:e.notes});c[i].versions.sort(function(a,b){return V(b.version).compareTo(a.version);});};for(i=0;i<d;i++){c[i]=o[c[i]];c[i].versions=[];if(c[i].relnotes){r=0;q.each(c[i].relnotes,p);if(r>0){R.push(c[i]);}}}this._oModel.setData({libs:R});this._hideBusyIndicator();},_requestResources:function(){this._oNeoAppJsonPromise=q.ajax(n);this._oSapUiVersionJsonPromise=q.ajax(s);},_resourceAvailabilityHandler:function(){q.when(this._oNeoAppJsonPromise,this._oSapUiVersionJsonPromise).then(function(N,S){this._oNeoAppVersions=N[0].routes;this._sSapUiVersion=S[0].version;this._oView.byId("VersionSelect").setVisible(true);}.bind(this),function(){L.warning("No neo-app.json was detected");});},_compareUI5Versions:function(v,a){var o=V(v),b=V(a);return(o.getMajor()+"."+o.getMinor())===(b.getMajor()+"."+b.getMinor());},_updateLastReleasedVersion:function(v){if(this._compareUI5Versions(v,this._sSapUiVersion)&&parseFloat(this._sLastReleasedVersion)>parseFloat(this._sSapUiVersion)){this._sLastReleasedVersion=this._sSapUiVersion;}},_getLastVersionFromNeoAppJson:function(S){var a=this._oNeoAppVersions?this._oNeoAppVersions.length:0,v,i;for(i=0;i<a;i++){v=this._oNeoAppVersions[i].target.version;if(this._compareUI5Versions(v,S)){return v;}}},handleVersionChange:function(e){var i=e.getParameter("selectedItem"),S=i.getKey();this._updateVersionInformation(S);},_updateVersionInformation:function(S){var v;this._sLastReleasedVersion=this._getLastVersionFromNeoAppJson(S);this._updateLastReleasedVersion(S);v=this._sLastReleasedVersion?this._sLastReleasedVersion:S;this._showBusyIndicator();l._loadAllLibInfo("","_getLibraryInfoAndReleaseNotes",v,this._processLibInfo.bind(this));},_showBusyIndicator:function(){this.byId("releaseNotesObjectPage").setBusy(true);},_hideBusyIndicator:function(){this.byId("releaseNotesObjectPage").setBusy(false);}});});

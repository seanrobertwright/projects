/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/Device',"sap/ui/thirdparty/jquery",'sap/ui/test/_LogCollector','sap/ui/test/_OpaLogger','sap/ui/test/_ParameterValidator','sap/ui/test/_UsageReport','sap/ui/test/_OpaUriParameterParser','sap/ui/test/_ValidationParameters'],function(D,$,_,a,b,c,d,e){"use strict";var l=a.getLogger("sap.ui.test.Opa"),L=_.getInstance(),q=[],f={},t=-1,s,Q,i,g,v=new b({errorPrefix:"sap.ui.test.Opa#waitFor"});L.start();function h(C,w){if(window["sap-ui-debug"]){w.timeout=w.debugTimeout;}var x=new Date();y();function y(){l.timestamp("opa.check");L.getAndClearLog();var R=C();g=w._stack;if(R.error){Q.reject(w);return;}if(R.result){j();return;}var P=(new Date()-x)/1000;if(w.timeout===0||w.timeout>P){t=setTimeout(y,w.pollingInterval);return;}n("Opa timeout after "+w.timeout+" seconds",w);if(w.error){try{w.error(w,R.arguments);}finally{Q.reject(w);}}else{Q.reject(w);}}}function j(){if(!q.length){if(Q){Q.resolve();}return true;}var w=q.shift();t=setTimeout(function(){h(w.callback,w.options);},(O.config.asyncPolling?w.options.pollingInterval:0)+O.config.executionDelay);}function k(w,N){var x=w.get();if(x){var y=q.splice(q.length-x,x);y.forEach(function(z){z.options._nestedIn=N;});q=y.concat(q);}}function m(E){var w=E.toString();if(E.stack){w+="\n"+E.stack;}var x="Exception thrown by the testcode:'"+w+"'";return x;}function n(E,w,x){var y=L.getAndClearLog();if(y){E+="\nThis is what Opa logged:\n"+y;}if(!x&&w._stack){E+=p(w);}if(w.errorMessage){w.errorMessage+="\n"+E;}else{w.errorMessage=E;}l.error(w.errorMessage,"Opa");}function o(w){w=(w||0)+2;if(D.browser.mozilla){w=w-1;}var E=new Error(),x=E.stack;if(!x){try{throw E();}catch(y){x=y.stack;}}if(!x){return"";}x=x.split("\n");x.splice(0,w);return x.join("\n");}function p(w){var R="\nCallstack:\n";if(w._stack){R+=w._stack;delete w._stack;}else{R+="Unknown";}if(w._nestedIn){R+=p(w._nestedIn);delete w._nestedIn;}return R;}var O=function(w){this.and=this;$.extend(this,w);};O.config={};O.extendConfig=function(w){var C=["actions","assertions","arrangements"];C.filter(function(A){return!!w[A];}).forEach(function(A){var N=w[A];var x=Object.getPrototypeOf(w[A]);var y=O.config[A];var z=Object.getPrototypeOf(O.config[A]);for(var K in y){if(!(K in N)){N[K]=y[K];}}for(var P in z){if(!(P in N)){x[P]=z[P];}}});O.config=$.extend(true,O.config,w,r);a.setLevel(O.config.logLevel);};var r=d._getOpaParams();var u=0;var I=D.browser.safari&&!D.browser.phantomJS;if(D.browser.msie||D.browser.edge||I){u=50;}O.resetConfig=function(){O.config=$.extend({arrangements:new O(),actions:new O(),assertions:new O(),timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:u,asyncPolling:false},r);};O.getContext=function(){return f;};O.emptyQueue=function emptyQueue(){if(i){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.");}i=true;s=null;Q=$.Deferred();j();return Q.promise().fail(function(w){q=[];if(s){var E=s.qunitTimeout?"QUnit timeout after "+s.qunitTimeout+" seconds":"Queue was stopped manually";w._stack=s.qunitTimeout&&g||o(1);n(E,w);}}).always(function(){q=[];t=-1;Q=null;g=null;i=false;});};O.stopQueue=function stopQueue(){O._stopQueue();};O._stopQueue=function(w){q=[];if(!Q){l.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}s=w||{};Q.reject(s);}};O.resetConfig();O._usageReport=new c(O.config);a.setLevel(O.config.logLevel);O.prototype={getContext:O.getContext,waitFor:function(w){var x=$.Deferred(),F=O._createFilteredConfig(O._aConfigValuesForWaitFor);w=$.extend({},F,w);this._validateWaitFor(w);w._stack=o(1+w._stackDropCount);delete w._stackDropCount;var y=$.extend({},this);x.promise(y);q.push({callback:function(){var C=true;if(w.check){try{C=w.check.apply(this,arguments);}catch(E){var z="Failure in Opa check function\n"+m(E);n(z,w,E.stack);x.reject(w);return{error:true,arguments:arguments};}}if(s){return{result:true,arguments:arguments};}if(!C){return{result:false,arguments:arguments};}if(w.success){var W=O._getWaitForCounter();try{w.success.apply(this,arguments);}catch(E){var z="Failure in Opa success function\n"+m(E);n(z,w,E.stack);x.reject(w);return{error:true,arguments:arguments};}finally{k(W,w);}}x.resolve();return{result:true,arguments:arguments};}.bind(this),options:w});return y;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,iWaitForPromise:function(P){return this._schedulePromiseOnFlow(P);},_schedulePromiseOnFlow:function(P,w){w=w||{};var x={};w.check=function(){if(!x.started){x.started=true;P.then(function(){x.done=true;},function(y){x.errorMessage="Error while waiting for promise scheduled on flow"+(y?", details: "+y:"");});}if(x.errorMessage){throw new Error(x.errorMessage);}else{return!!x.done;}};return this.waitFor(w);},_validateWaitFor:function(P){v.validate({validationInfo:e.OPA_WAITFOR,inputToValidate:P});}};O._createFilteredOptions=function(A,S){var F={};A.forEach(function(K){var C=S[K];if(C===undefined){return;}F[K]=C;});return F;};O._createFilteredConfig=function(A){return O._createFilteredOptions(A,O.config);};O._getWaitForCounter=function(){var w=q.length;return{get:function(){var x=q.length-w;return Math.max(x,0);}};};O._aConfigValuesForWaitFor=["errorMessage","timeout","debugTimeout","pollingInterval","_stackDropCount","asyncPolling"];return O;},true);

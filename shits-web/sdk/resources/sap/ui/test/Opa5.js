/*!
* OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(['sap/ui/test/Opa','sap/ui/test/OpaPlugin','sap/ui/test/PageObjectFactory','sap/ui/base/Object','sap/ui/test/launchers/iFrameLauncher','sap/ui/test/launchers/componentLauncher','sap/ui/core/routing/HashChanger','sap/ui/test/matchers/Matcher','sap/ui/test/matchers/AggregationFilled','sap/ui/test/matchers/PropertyStrictEquals','sap/ui/test/pipelines/ActionPipeline','sap/ui/test/_ParameterValidator','sap/ui/test/_OpaLogger','sap/ui/thirdparty/URI','sap/ui/base/EventProvider','sap/ui/qunit/QUnitUtils','sap/ui/test/autowaiter/_autoWaiter','sap/ui/dom/includeStylesheet','sap/ui/thirdparty/jquery','sap/ui/test/_OpaUriParameterParser',"sap/ui/test/_ValidationParameters"],function(O,a,P,U,f,c,H,M,A,b,d,_,e,g,E,Q,h,j,$,k,l){"use strict";var L=e.getLogger("sap.ui.test.Opa5"),p=new a(),o=new d(),F="OpaFrame",v=new _({errorPrefix:"sap.ui.test.Opa5#waitFor"}),C=["visible","enabled","viewNamespace","viewName","viewId","fragmentId","autoWait"].concat(O._aConfigValuesForWaitFor),m=["check","error","success"].concat(O._aConfigValuesForWaitFor),n=[],q=new E();var r=k._getAppParams();var s=new g().search(true);var t=U.extend("sap.ui.test.Opa5",$.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function S(){var i=this;var B={};var D=["source","timeout","autoWait","width","height"];if(arguments.length===1&&$.isPlainObject(arguments[0])){B=arguments[0];}else{var V=arguments;D.forEach(function(N,R){B[N]=V[R];});}if(B.source&&typeof B.source!=="string"){B.source=B.source.toString();}var G=new g(B.source?B.source:'');G.search($.extend(G.search(true),O.config.appParams));var I=w();I.success=function(){u({source:G.toString(),width:B.width||O.config.frameWidth,height:B.height||O.config.frameHeight});};this.waitFor(I);var J=w();J.check=f.hasLaunched;J.timeout=B.timeout||80;J.errorMessage="unable to load the IFrame with the url: "+B.source;i.waitFor(J);var K=w();K.success=function(){i._loadExtensions(f.getWindow());};this.waitFor(K);var W=w();W.autoWait=B.autoWait||false;W.timeout=B.timeout||80;return this.waitFor(W);}t.prototype.iStartMyUIComponent=function iStartMyUIComponent(i){var B=this;var D=false;i=i||{};var G=w();G.success=function(){var N=new g();N.search($.extend(N.search(true),O.config.appParams));window.history.replaceState({},"",N.toString());};this.waitFor(G);var I=w();I.success=function(){var N=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";j(N);H.getInstance().setHash(i.hash||"");c.start(i.componentConfig).then(function(){D=true;});};this.waitFor(I);var J=w();J.errorMessage="Unable to load the component with the name: "+i.name;J.check=function(){return D;};if(i.timeout){J.timeout=i.timeout;}B.waitFor(J);var K=w();K.success=function(){B._loadExtensions(window);};this.waitFor(K);var W=w();W.autoWait=i.autoWait||false;W.timeout=i.timeout||80;return this.waitFor(W);};t.prototype.iTeardownMyUIComponent=function iTeardownMyUIComponent(){var i=w();i.success=function(){c.teardown();};var B=w();B.success=function(){var D=new g();D.search(s);window.history.replaceState({},"",D.toString());};return $.when(this.waitFor(i),this.waitFor(B));};t.prototype.iTeardownMyApp=function(){var i=this;var B=w();B.success=function(){i._unloadExtensions(t.getWindow());};var D=w();D.success=function(){if(f.hasLaunched()){this.iTeardownMyAppFrame();}else if(c.hasLaunched()){this.iTeardownMyUIComponent();}else{var G="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";L.error(G,"Opa");throw new Error(G);}}.bind(this);return $.when(this.waitFor(B),this.waitFor(D));};t.iStartMyAppInAFrame=S;t.prototype.iStartMyAppInAFrame=S;function T(){var W=w();W.success=function(){f.teardown();};return this.waitFor(W);}t.iTeardownMyAppFrame=T;t.prototype.iTeardownMyAppFrame=T;t.prototype.hasAppStartedInAFrame=function(){return f.hasLaunched();};t.prototype.hasUIComponentStarted=function(){return c.hasLaunched();};t.prototype.hasAppStarted=function(){return f.hasLaunched()||c.hasLaunched();};t.prototype.waitFor=function(i){var B=x(i);var D=y(i,B);if(D){D.success=function(N){var X=jQuery.isArray(N)?N[0]:N;var Y=z(i,B,X);return t.prototype.waitFor.call(this,Y);};return t.prototype.waitFor.call(this,D);}var G=i.actions,I=O._createFilteredConfig(C),J;i=$.extend({},I,i);i.actions=G;v.validate({validationInfo:l.OPA5_WAITFOR,inputToValidate:i});var K=i.check,N=null,R=i.success,V,W;J=O._createFilteredOptions(m,i);J.check=function(){var X=!!i.actions||i.autoWait;var Y=t._getAutoWaiter();Y.extendConfig(i.autoWait);if(X&&Y.hasToWait()){return false;}var p=t.getPlugin();var Z=$.extend({},i,{interactable:X});V=p._getFilteredControls(Z,N);if(f.hasLaunched()&&$.isArray(V)){var a1=[];V.forEach(function(b1){a1.push(b1);});V=a1;}if(V===a.FILTER_FOUND_NO_CONTROLS){L.debug("Matchers found no controls so check function will be skipped");return false;}if(K){return this._executeCheck(K,V);}return true;};J.success=function(){var X=O._getWaitForCounter();if(G&&(V||!W)){o.process({actions:G,control:V});}if(!R){return;}var Y=[];if(V){Y.push(V);}if(X.get()===0){L.timestamp("opa.waitFor.success");L.debug("Execute success handler");R.apply(this,Y);return;}var Z=w();if($.isPlainObject(i.autoWait)){Z.autoWait=$.extend({},i.autoWait);}else{Z.autoWait=i.autoWait;}Z.success=function(){R.apply(this,Y);};this.waitFor(Z);};return O.prototype.waitFor.call(this,J);};t.getPlugin=function(){return f.getPlugin()||p;};t.getJQuery=function(){return f.getJQuery()||$;};t.getWindow=function(){return f.getWindow()||window;};t.getUtils=function(){return f.getUtils()||Q;};t.getHashChanger=function(){return f.getHashChanger()||H.getInstance();};t._getAutoWaiter=function(){return f._getAutoWaiter()||h;};t.extendConfig=function(i){O.extendConfig(i);O.extendConfig({appParams:r});t._getAutoWaiter().extendConfig(i.autoWait);};t.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new t(),actions:new t(),assertions:new t(),visible:true,enabled:undefined,autoWait:false,_stackDropCount:1});O.extendConfig({appParams:r});};t.getTestLibConfig=function(i){return O.config.testLibs&&O.config.testLibs[i]?O.config.testLibs[i]:{};};t.emptyQueue=O.emptyQueue;t.stopQueue=O.stopQueue;t.getContext=O.getContext;t.matchers={};t.matchers.Matcher=M;t.matchers.AggregationFilled=A;t.matchers.PropertyStrictEquals=b;t.createPageObjects=function(i){return P.create(i,t);};t.prototype._executeCheck=function(i,B){var D=[];B&&D.push(B);L.debug("Executing OPA check function on controls "+B);L.debug("Check function is:\n"+i);var R=i.apply(this,D);L.debug("Result of check function is: "+R||"not defined or null");return R;};t.prototype.iWaitForPromise=function(i){var B=w();return O.prototype._schedulePromiseOnFlow.call(this,i,B);};t.resetConfig();function u(i){var I=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";j(I);var B=$.extend({},i,{frameId:F,opaLogLevel:O.config.logLevel});return f.launch(B);}function w(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};}$(function(){if($("#"+F).length){u();}$("body").addClass("sapUiBody");$("html").height("100%");});t._getEventProvider=function(){return q;};t.prototype._loadExtensions=function(i){var B=this;var D=O.config.extensions?O.config.extensions:[];var G=$.when($.map(D,function(I){var J;var K=$.Deferred();i.sap.ui.require([I],function(N){J=new N();J.name=I;B._executeExtensionOnAfterInit(J,i).done(function(){t._getEventProvider().fireEvent('onExtensionAfterInit',{extension:J,appWindow:i});B._addExtension(J);K.resolve();}).fail(function(R){L.error(new Error("Error during extension init: "+R),"Opa");K.resolve();});});return K.promise();}));return this.iWaitForPromise(G);};t.prototype._unloadExtensions=function(i){var B=this;var D=$.when($.map(this._getExtensions(),function(G){var I=$.Deferred();t._getEventProvider().fireEvent('onExtensionBeforeExit',{extension:G});B._executeExtensionOnBeforeExit(G,i).done(function(){I.resolve();}).fail(function(J){L.error(new Error("Error during extension init: "+J),"Opa");I.resolve();});return I.promise();}));this.iWaitForPromise(D);};t.prototype._addExtension=function(i){n.push(i);};t.prototype._getExtensions=function(){return n;};t.prototype._executeExtensionOnAfterInit=function(i,B){var D=$.Deferred();var G=i.onAfterInit;if(G){G.bind(B)().done(function(){D.resolve();}).fail(function(I){D.reject(new Error("Error while waiting for extension: "+i.name+" to init, details: "+I));});}else{D.resolve();}return D.promise();};t.prototype._executeExtensionOnBeforeExit=function(i,B){var D=$.Deferred();var G=i.onBeforeExit;if(G){G.bind(B)().done(function(){D.resolve();}).fail(function(I){D.reject(new Error("Error while waiting for extension: "+i.name+" to exit, details: "+I));});}else{D.resolve();}return D.promise();};function x(i){var B="matchers";var D="ancestor";var G="descendant";if(i[D]&&jQuery.isPlainObject(i[D])){return[D];}else if(i[B]&&i[B][D]&&jQuery.isPlainObject(i[B][D])){return[B,D];}else if(i[G]&&jQuery.isPlainObject(i[G])){return[G];}else if(i[B]&&i[B][G]&&jQuery.isPlainObject(i[B][G])){return[B,G];}}function y(i,B){if(B){var R=i;B.forEach(function(D){if(R[D]!==undefined){R=R[D];}});return R;}}function z(B,D,G){if(D){var R=jQuery.extend({},B);var I=R;var i=0;while(i<D.length-1){I=R[D[i++]];}I[D[i]]=G;return R;}}return t;});

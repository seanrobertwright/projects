/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Variant","sap/ui/fl/Change","sap/base/util/ObjectPath","sap/base/util/includes","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/base/util/restricted/_pick","sap/ui/fl/apply/_internal/controlVariants/Utils"],function(V,C,O,i,_,L,U,a,F,b,c){"use strict";function d(p){var r=[];if(p.variantData.content.variantReference){r=k.getVariantChanges(Object.assign(p,{vReference:p.variantData.content.variantReference,changeInstance:true}));return r.filter(function(R){return a.compareAgainstCurrentLayer(R.getDefinition().layer,p.variantData.content.layer)===-1;});}return r;}function e(p){var v=k.getContent(p.reference);var l=O.get([p.vmReference,"variants"],v);return l||[];}function f(v,o,A){var s=o.changeType;if(!v){v={};}if(!v[s]){v[s]=[];}if(A){v[s].push(o);return true;}return v[s].some(function(E,I){if(E.fileName===o.fileName){v[s].splice(I,1);return true;}});}function g(o,l){var s=j(o);l[s].push(o);}function h(o,l){var s=j(o);var m=-1;l[s].some(function(E,I){if(E.fileName===o.fileName){m=I;return true;}});if(m>-1){l[s].splice(m,1);}}function j(o){switch(o.fileType){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";}}var k={getContent:function(r){return F.getVariantsState(r);},getVariantChanges:function(p){var v=k.getContent(p.reference);var s=p.vReference||v[p.vmReference].defaultVariant;var r=[];if(s&&typeof s==="string"){var o=k.getVariant(Object.assign(p,{vReference:s}));r=o.controlChanges;if(p.changeInstance){r=r.map(function(l,m){var n;if(!l.getDefinition){n=new C(l);o.controlChanges.splice(m,1,n);}else{n=l;}return n;});}}return r;},getVariant:function(p){var v;var l=e(p);l.some(function(o){if(o.content.fileName===p.vReference){v=o;return true;}});return v;},addVariantToVariantManagement:function(p){var v=k.getContent(p.reference);var l=v[p.vmReference].variants.slice().splice(1);var I=c.getIndexToSortVariant(l,p.variantData);if(p.variantData.content.variantReference){var r=d(p);p.variantData.controlChanges=r.concat(p.variantData.controlChanges);}v[p.vmReference].variants.splice(I+1,0,p.variantData);return I+1;},removeVariantFromVariantManagement:function(p){var I;var v=k.getContent(p.reference);var l=v[p.vmReference].variants.some(function(o,m){var n=new V(o);if(n.getId()===p.variant.getId()){I=m;return true;}});if(l){v[p.vmReference].variants.splice(I,1);}return I;},setVariantData:function(p){var v=k.getContent(p.reference);var l=v[p.vmReference].variants;var o=l[p.previousIndex];Object.keys(p.variantData).forEach(function(P){if(o.content.content[P]){o.content.content[P]=p.variantData[P];}});if(o.content.fileName!==p.vmReference){l.splice(p.previousIndex,1);var s=c.getIndexToSortVariant(l.slice(1),o);l.splice(s+1,0,o);return s+1;}l.splice(p.previousIndex,1,o);return p.previousIndex;},addChangeToVariant:function(p){var E=k.getVariantChanges(Object.assign(p,{changeInstance:true}));var l=E.map(function(o){return o.getDefinition().fileName;});if(!i(l,p.change.getDefinition().fileName)){var v=k.getVariant(p);v.controlChanges=E.concat([p.change]);return true;}return false;},removeChangeFromVariant:function(p){var l=k.getVariantChanges(Object.assign(p,{changeInstance:true}));var v=k.getVariant(p);var m=false;if(v){v.controlChanges=l.filter(function(o){if(!m&&o.getId()===p.change.getId()){m=true;return false;}return true;});}return m;},loadInitialChanges:function(p){var v=k.getContent(p.reference);return Object.keys(v).reduce(function(I,s){var l=v[s].currentVariant?"currentVariant":"defaultVariant";var A={vmReference:s,vReference:v[s][l],reference:p.reference};return I.concat(k.getVariantChanges(Object.assign({},p,A)));},[]);},fillVariantModel:function(p){var v=k.getContent(p.reference);return Object.keys(v).reduce(function(o,s){o[s]={defaultVariant:v[s].defaultVariant,variants:[]};if(v[s].currentVariant){o[s].currentVariant=v[s].currentVariant;}e(Object.assign(p,{vmReference:s})).forEach(function(l,m){o[s].variants[m]=JSON.parse(JSON.stringify({key:l.content.fileName,title:l.content.content.title,layer:l.content.layer,favorite:l.content.content.favorite,visible:l.content.content.visible,author:O.get("content.support.user",l)}));});return o;},{});},updateChangesForVariantManagementInMap:function(p){var v=k.getContent(p.reference);var o=v[p.vmReference];if(p.changeContent.fileType==="ctrl_variant_change"){o.variants.some(function(l){if(l.content.fileName===p.changeContent.selector.id){return f(l.variantChanges,p.changeContent,p.add);}});}else if(p.changeContent.fileType==="ctrl_variant_management_change"){return f(o.variantManagementChanges,p.changeContent,p.add);}},setCurrentVariant:function(p){var v=k.getContent(p.reference);v[p.vmReference].currentVariant=p.newVReference;},updateVariantsState:function(p){var o=F.getFlexObjectsFromStorageResponse(p.reference);if(!o.variantSection){L.error("Variant management state is not initialized yet");return;}o.variantSection=p.content;if(p.changeToBeAddedOrDeleted){switch(p.changeToBeAddedOrDeleted.getPendingAction()){case"NEW":g(p.changeToBeAddedOrDeleted.getDefinition(),o);break;case"DELETE":h(p.changeToBeAddedOrDeleted.getDefinition(),o);break;}}}};return k;},true);

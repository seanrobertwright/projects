/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils"],function(i,J,U){"use strict";var P="sap.ui.fl:PendingChange";var D={};function g(s,A){return J.getControlIdBySelector(s,A);}function c(C){return{changeObject:C,dependencies:[],controlsDependencies:[],dependentIds:[]};}function a(s,C,m){if(!m.mChanges[s]){m.mChanges[s]=[];}if(!i(m.mChanges[s],C)){m.mChanges[s].push(C);}if(!i(m.aChanges,C)){m.aChanges.push(C);}}function b(C,A,m){var s=C.getSelector();if(s&&s.id){var S=g(s,A);a(S,C,m);if(s.idIsLocal===undefined&&S.indexOf("---")!==-1){var k=S.split("---")[0];if(k!==A.getId()){S=S.split("---")[1];S=A.createId(S);a(S,C,m);}}}return m.aChanges;}function d(C,A,k,m){var l=C.getDependentSelectorList();e(C,l,A,m);k.slice(0,k.length-1).reverse().forEach(function(E){var n=E.getDependentSelectorList();l.some(function(o){var p=U.indexOfObject(n,o);if(p>-1){var q=g(o,A);f(C,E,q,m);return true;}});});}function e(o,k,A,C){if(k.length){var l=k.map(function(s){return g(s,A);});if(!C.mDependencies[o.getId()]){C.mDependencies[o.getId()]=c(o);}C.mDependencies[o.getId()].controlsDependencies=l;l.forEach(function(I){C.mControlsWithDependencies[I]=C.mControlsWithDependencies[I]||[];C.mControlsWithDependencies[I].push(o.getId());});}}function f(o,C,k,m){if(h(o,C,k,m)){m.mDependencies[o.getId()].dependencies.push(C.getId());m.mDependencies[o.getId()].dependentIds.push(k);if(!m.mDependentChangesOnMe[C.getId()]){m.mDependentChangesOnMe[C.getId()]=[];}m.mDependentChangesOnMe[C.getId()].push(o.getId());}}function h(o,C,k,m){var s=i(m.mDependencies[o.getId()].dependentIds,k);var I=false;if(m.mDependentChangesOnMe[C.getId()]){m.mDependentChangesOnMe[C.getId()].some(function(l){I=i(m.mDependencies[o.getId()].dependencies,l);return I;});}return!s&&!I;}function j(C){var k=[];var l=[];var p=[];C.dependencyRemovedInLastBatch.forEach(function(s){var o=C.mDependencies[s];if(o.dependencies.length===0&&!(o.controlsDependencies&&o.controlsDependencies.length)){l.push(s);k.push(o.changeObject.getId());if(o[P]){p.push(function(){return o[P]();});}}});return U.execPromiseQueueSequentially(p).then(function(){C.dependencyRemovedInLastBatch=[];l.forEach(function(s){delete C.mDependencies[s];});k.forEach(function(s){D.removeChangeFromDependencies(C,s);});return!!k.length;});}D.createEmptyDependencyMap=function(){return{aChanges:[],mChanges:{},mDependencies:{},mDependentChangesOnMe:{},mControlsWithDependencies:{},dependencyRemovedInLastBatch:[]};};D.addChangeAndUpdateDependencies=function(C,A,m){var k=b(C,A,m);d(C,A,k,m);};D.addRuntimeChangeAndUpdateDependencies=function(C,A,m,I){var k=b(C,A,m);d(C,A,k,I);};D.processDependentQueue=function(C,A){return j(C).then(function(k){if(k){return D.processDependentQueue(C,A);}});};D.addChangeApplyCallbackToDependency=function(C,s,k){C.mDependencies[s][P]=k;};D.removeControlsDependencies=function(C,s){var k=C.mControlsWithDependencies[s];if(k){k.forEach(function(l){var o=C.mDependencies[l];if(o&&o.controlsDependencies&&o.controlsDependencies.length){var I=o.controlsDependencies.indexOf(s);if(I>-1){o.controlsDependencies.splice(I,1);delete C.mControlsWithDependencies[s];if(!i(C.dependencyRemovedInLastBatch,l)){C.dependencyRemovedInLastBatch.push(l);}}}});delete C.mControlsWithDependencies[s];}};D.removeChangeFromDependencies=function(C,s){var m=C.mDependentChangesOnMe[s];if(m){m.forEach(function(k){var o=C.mDependencies[k];var I=o?o.dependencies.indexOf(s):-1;if(I>-1){o.dependencies.splice(I,1);if(!i(C.dependencyRemovedInLastBatch,k)){C.dependencyRemovedInLastBatch.push(k);}}});delete C.mDependentChangesOnMe[s];}};D.checkForOpenDependenciesForControl=function(C,I,A){return Object.keys(C.mDependencies).some(function(k){return C.mDependencies[k].changeObject.getDependentSelectorList().some(function(o){return J.getControlIdBySelector(o,A)===I;});});};return D;});

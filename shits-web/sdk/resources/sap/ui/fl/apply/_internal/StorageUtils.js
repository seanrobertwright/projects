/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/base/util/isEmptyObject"],function(e,L,c,d,i){"use strict";var A="sap/ui/fl/apply/_internal/connectors/";var S={connector:"StaticFileConnector"};function _(l,v){return l.filter(function(a){return v.indexOf(a)!==-1||v[0]==="ALL";});}function s(r){function b(C,o){return new Date(C.creation)-new Date(o.creation);}["changes","variantChanges","variants","variantDependentControlChanges","variantManagementChanges"].forEach(function(a){r[a]=r[a].sort(b);});return r;}function f(n,l,C){return C.map(function(m){var a=m.connector;var b;if(!m.custom){b=n+a;}else{b=l?m.applyConnector:m.writeConnector;}return b;});}function g(n,l,C){var a=f(n,l,C);return new Promise(function(r){sap.ui.require(a,function(){Array.from(arguments).forEach(function(o,I){if(!l){if(!C[I].layers){C[I].layers=o.layers;}else{C[I].layers=_(C[I].layers,o.layers);}}if(l){C[I].applyConnectorModule=o;}else{C[I].writeConnectorModule=o;}});r(C);});});}return{getConnectors:function(n,l){var C=sap.ui.getCore().getConfiguration().getFlexibilityServices();var m=[];if(l){m=[S];}m=m.concat(C);return g(n,l,m);},getApplyConnectors:function(){return this.getConnectors(A,true);},getStaticFileConnector:function(){return g(A,true,[S]);},logAndResolveDefault:function(r,C,F,E){L.error("Connector ("+C.connector+") failed call '"+F+"': "+E);return r;},filterAndSortResponses:function(G){var r=[];Object.keys(G).forEach(function(l){r.push(G[l]);});r=r.filter(function(R){return R.changes.length>0||R.variants.length>0||R.variantChanges.length>0||R.variantManagementChanges.length>0||R.variantDependentControlChanges.length>0;});r.sort(function(a,b){return a.index-b.index;});return r;},getGroupedFlexObjects:function(F){var G={};Object.keys(c).forEach(function(l){G[l]=this.getEmptyFlexDataResponse();G[l].index=d.getLayerIndex(l);}.bind(this));F.forEach(function(o){var l=o.layer;if(o.fileType==="ctrl_variant"&&o.variantManagementReference){G[l].variants.push(o);}else if(o.fileType==="ctrl_variant_change"){G[l].variantChanges.push(o);}else if(o.fileType==="ctrl_variant_management_change"){G[l].variantManagementChanges.push(o);}else if(o.fileType==="change"||o.fileType==="variant"){if(o.variantReference){G[l].variantDependentControlChanges.push(o);}else{G[l].changes.push(o);}}});Object.keys(G).forEach(function(l){s(G[l]);});return G;},getEmptyFlexDataResponse:function(){return Object.assign({},{appDescriptorChanges:[],changes:[],variants:[],variantChanges:[],variantDependentControlChanges:[],variantManagementChanges:[],ui2personalization:{}});},isStorageResponseFilled:function(r){return Object.keys(r||{}).some(function(k){if(Array.isArray(r[k])){return r[k].length!==0;}return!i(r[k]);});}};});

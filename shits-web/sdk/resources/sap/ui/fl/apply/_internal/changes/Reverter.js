/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/Utils"],function(L,F,U,a){"use strict";function _(c,C,o,p){var s=false;var d=p.modifier.getControlType(C);if(c.getChangeType()==="stashControl"&&d==="sap.ui.core._StashedControl"){s=true;if(!c.hasRevertData()){o.setChangeRevertData(c,false);}}return s;}function b(c){if(!c.isApplyProcessFinished()&&c.hasApplyProcessStarted()){return c.addPromiseForApplyProcessing().then(function(r){if(r&&r.error){c.markRevertFinished(r.error);throw Error(r.error);}});}}var R={revertChangeOnControl:function(c,C,p){var m=U.getControlIfTemplateAffected(c,C,p);var o;return U.getChangeHandler(c,m,p).then(function(r){o=r;}).then(b.bind(null,c)).then(function(){var s=_(c,C,o,p);if(c.isApplyProcessFinished()||s){if(!c.hasRevertData()){c.setRevertData(F.getParsedRevertDataFromCustomData(C,c,p.modifier));}c.startReverting();return o.revertChange(c,m.control,p);}throw Error("Change was never applied");}).then(function(){m.control=p.modifier.bySelector(c.getSelector(),p.appComponent,p.view);if(m.bTemplateAffected){p.modifier.updateAggregation(m.control,c.getContent().boundAggregation);}c.markRevertFinished();return m.control;}).catch(function(e){var E="Change could not be reverted: "+e.message;L.error(E);c.markRevertFinished(E);return false;});},revertMultipleChanges:function(c,p){var P=[];c.forEach(function(C){C.setQueuedForRevert();P.push(function(){var s=C.getSelector&&C.getSelector();var o=p.modifier.bySelector(s,p.appComponent);if(!o){L.warning("A flexibility change tries to revert changes on a nonexistent control with id "+s.id);return new a.FakePromise();}var r={modifier:p.modifier,appComponent:p.appComponent,view:a.getViewForControl(o)};return R.revertChangeOnControl(C,o,r).then(function(v){F.destroyAppliedCustomData(v||o,C,p.modifier);return!!v;}).then(function(S){if(S){p.flexController._oChangePersistence._deleteChangeInMap(C);}});});});return a.execPromiseQueueSequentially(P);}};return R;},true);

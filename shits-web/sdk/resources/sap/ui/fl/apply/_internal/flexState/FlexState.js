/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/Component","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/prepareVariantsMap","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/base/Log"],function(m,O,C,S,L,p,a,b,c,U,d){"use strict";var F={};var _={};var e={};var f={};var g={appDescriptorMap:p,changesMap:a,variantsMap:b};function h(P){var w=C.get(P.componentId);_[P.reference].componentData=w?w.getComponentData():P.componentData;}function i(P){var w=C.get(P.componentId);P.componentData=P.componentData||w.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||w.getManifestObject();P.reference=P.reference||U.getComponentClassName(w);}function j(R,M){if(!_[R]){throw Error("State is not yet initialized");}if(!_[R].preparedMaps[M]){var P={unfilteredStorageResponse:_[R].unfilteredStorageResponse,storageResponse:_[R].storageResponse,componentId:_[R].componentId,componentData:_[R].componentData};_[R].preparedMaps[M]=F._callPrepareFunction(M,P);}return _[R].preparedMaps[M];}function k(R){return j(R,"appDescriptorMap");}function l(R){return j(R,"changesMap");}function n(R){return j(R,"variantsMap");}function o(P){if(P.reference.endsWith(".Component")){var w=P.reference.split(".");w.pop();var R=w.join(".");_[R]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId,partialFlexState:P.partialFlexState});f[R]=f[P.reference];}}function q(R){var w=m({},R);var x=w.changes;var y=["changes","variants","variantChanges","variantDependentControlChanges","variantManagementChanges"];if(c.isLayerFilteringRequired()){y.forEach(function(T){x[T]=c.filterChangeDefinitionsByMaxLayer(x[T]);});}return w;}function r(P){f[P.reference]=L.loadFlexData(P).then(function(R){_[P.reference]=m({},{unfilteredStorageResponse:R,preparedMaps:{},componentId:P.componentId,componentData:P.componentData,partialFlexState:P.partialFlexState});o(P);s(P.reference);return R;});return f[P.reference];}function s(R){var w=c.getUshellContainer();if(w){e[R]=u.bind(null,R);w.getService("ShellNavigation").registerNavigationFilter(e[R]);}}function t(R){var w=c.getUshellContainer();if(w&&e[R]){w.getService("ShellNavigation").unregisterNavigationFilter(e[R]);delete e[R];}}function u(R,N,w){var x=c.getUshellContainer();if(x){var y=x.getService("ShellNavigation");try{var z=c.getMaxLayerTechnicalParameter(N);var P=c.getMaxLayerTechnicalParameter(w);if(z!==P){F.clearMaxLayerFiltering(R);}}catch(E){d.error(E.message);}return y.NavigationFilterStatus.Continue;}}function v(R){if(_[R]){_[R].preparedMaps={};if(_[R].unfilteredStorageResponse.changes){delete _[R].unfilteredStorageResponse.changes.variantSection;}}}F.initialize=function(P){return Promise.resolve().then(function(P){i(P);if(f[P.reference]){return f[P.reference].then(function(P){if(_[P.reference].partialFlexState===true&&P.partialFlexState!==true){P.partialFlexData=_[P.reference].unfilteredStorageResponse.changes;return r(P);}if(_[P.reference].componentId!==P.componentId){return r(P);}return _[P.reference].unfilteredStorageResponse;}.bind(null,P));}return r(P);}.bind(null,P)).then(function(P,R){if(!_[P.reference].storageResponse){_[P.reference].storageResponse=q(R);h(P);F.getVariantsState(P.reference);}}.bind(null,P));};F.clearAndInitialize=function(P){i(P);var V=!!O.get(["preparedMaps","variantsMap"],_[P.reference]);F.clearState(P.reference);F.clearState(U.normalizeReference(P.reference));return F.initialize(P).then(function(V,R){if(V){return F.getVariantsState(R);}}.bind(null,V,P.reference));};F.clearState=function(R){if(R){t(R);delete _[R];delete f[R];}else{Object.keys(_).forEach(function(R){t(R);});_={};f={};}};F.clearMaxLayerFiltering=function(R){delete _[R].storageResponse;v(R);};F.getUIChanges=function(R){return l(R).changes;};F.getAppDescriptorChanges=function(R){return k(R).appDescriptorChanges;};F.getVariantsState=function(R){var V=n(R);return V;};F.getUI2Personalization=function(R){return _[R].unfilteredStorageResponse.changes.ui2personalization;};F._callPrepareFunction=function(M,P){return g[M](P);};F.getStorageResponse=function(R){if(f[R]){return f[R].then(function(){return _[R].unfilteredStorageResponse;});}};F.getFlexObjectsFromStorageResponse=function(R){return _[R]&&_[R].unfilteredStorageResponse.changes;};return F;},true);

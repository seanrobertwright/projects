/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/base/util/includes"],function(C,U,L,m,O,i,M,h,a){"use strict";var _={};function b(n,o){var A=[];return n.reduce(function(r,v){var V=o.getVariantManagementReference(v).variantManagementReference;if(V){if(a(A,V)){r.updateRequired=true;return r;}A.push(V);}if(V&&o.oData[V].currentVariant!==v){r.updateRequired=true;if(o.oData[V].currentVariant!==o.oData[V].defaultVariant){r.parameters.push(o.oData[V].currentVariant);}}else{r.parameters.push(v);}return r;},{updateRequired:false,parameters:[]});}function c(p,o){var r=O.get(["params",j.variantTechnicalParameterName],p);if(r){var u=b(r,o);if(u.updateRequired){j.update({updateURL:!o._bDesignTimeMode,parameters:u.parameters,updateHashEntry:true,model:o});}}}function d(o,n){var u=U.getUshellContainer();var S=u.getService("ShellNavigation");try{var k=u.getService("URLParsing");var N=k.parseShellHash(n);c(N,o);}catch(E){L.error(E.message);}return S.NavigationFilterStatus.Continue;}function e(o){var r=U.getComponentClassName(o.oAppComponent);var u=U.getUshellContainer();if(!_[r]&&u){_[r]=d.bind(null,o);u.getService("ShellNavigation").registerNavigationFilter(_[r]);}}function f(o){var r=U.getComponentClassName(o.oAppComponent);var u=U.getUshellContainer();if(_[r]&&u){u.getService("ShellNavigation").unregisterNavigationFilter(_[r]);delete _[r];}}function s(p){var P=U.getParsedURLHash(j.variantTechnicalParameterName);if(P.params){var t=U.getTechnicalParametersForComponent(p.model.oAppComponent);if(!t){L.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged");}if(p.parameters.length===0){delete P.params[j.variantTechnicalParameterName];t&&delete t[j.variantTechnicalParameterName];}else{P.params[j.variantTechnicalParameterName]=p.parameters;t&&(t[j.variantTechnicalParameterName]=p.parameters);}if(p.silent){h.changed.active=false;h.replaceHash(U.getUshellContainer().getService("URLParsing").constructShellHash(P));h.changed.active=true;}else{var o=U.getUshellContainer().getService("CrossApplicationNavigation");o.toExternal({target:{semanticObject:P.semanticObject,action:P.action,context:P.contextRaw},params:P.params,appSpecificRoute:P.appSpecificRoute,writeHistory:false});}}}function g(p){var r={index:-1};var u=U.getParsedURLHash().params;if(u){r.parameters=[];if(p.model._bDesignTimeMode){u[j.variantTechnicalParameterName]=j.getStoredHashParams(p);}if(Array.isArray(u[j.variantTechnicalParameterName])){u[j.variantTechnicalParameterName]=u[j.variantTechnicalParameterName].map(decodeURIComponent);u[j.variantTechnicalParameterName].some(function(P,I){if(p.model.oVariantController.getVariant(p.vmReference,P)){r.index=I;return true;}});}}return m(r,u&&u[j.variantTechnicalParameterName]&&{parameters:u[j.variantTechnicalParameterName]});}var j={variantTechnicalParameterName:"sap-ui-fl-control-variant-id",initialize:function(p){var P=U.getParsedURLHash();var k=P.params&&P.params[j.variantTechnicalParameterName];j.attachHandlers(p);j.update({model:p.model,parameters:k,updateHashEntry:Array.isArray(k)&&k.length>0});c(P,p.model);},updateVariantInURL:function(p){var u=j.removeURLParameterForVariantManagement(p);if(!u.parameters){return;}var P=u.parameters||[];var I=u.index;var k=p.newVReference===p.model.oData[p.vmReference].defaultVariant;if(!k){if(I===-1){P=P.concat([p.newVReference]);}else{P=P.slice(0,I).concat([p.newVReference],P.slice(I));}}if(!k||I>-1){j.update({parameters:P,updateURL:!p.model._bDesignTimeMode,updateHashEntry:true,model:p.model});}},removeURLParameterForVariantManagement:function(p){var v=g(p);if(v.index>-1){v.parameters.splice(v.index,1);}return v;},attachHandlers:function(p){function o(){return p.model._oVariantSwitchPromise.then(function(){p.model._oHashData.controlPropertyObservers.forEach(function(k){k.destroy();});f(p.model);p.model.oChangePersistence.resetVariantMap();p.model.destroy();p.model.oComponentDestroyObserver.unobserve(p.model.oAppComponent,{destroy:true});p.model.oComponentDestroyObserver.destroy();});}e(p.model);if(!p.model.oComponentDestroyObserver&&p.model.oAppComponent instanceof C){p.model.oComponentDestroyObserver=new M(o.bind(null));p.model.oComponentDestroyObserver.observe(p.model.oAppComponent,{destroy:true});}},registerControl:function(p){if(p.updateURL){p.model._oHashData.variantControlIds.push(p.vmReference);}},update:function(p){if(!p.model._oHashData){p.model._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]};}if(!p||!Array.isArray(p.parameters)){L.info("Variant URL parameters could not be updated since invalid parameters were received");return;}if(p.updateURL){s(p);}if(p.updateHashEntry&&!i(p.model)){p.model._oHashData.hashParams=p.parameters;}},getStoredHashParams:function(p){return Array.prototype.slice.call(p.model._oHashData.hashParams);},handleModelContextChange:function(p){var k="modelContextChange";function l(E,P){var v=P.model.getVariantManagementReferenceForControl(E.getSource());var V=P.model._oHashData.variantControlIds;var I=V.indexOf(v);if(I>-1){V.slice(I).forEach(function(n){if(g({vmReference:n,model:p.model}).index===-1){P.model.switchToDefaultForVariantManagement(n);}});}}var o=new M(function(E){if(E.current===true&&E.old===false){E.object.attachEvent(k,{model:p.model},l);}else if(E.current===false&&E.old===true){E.object.detachEvent(k,l);}});o.observe(p.vmControl,{properties:["resetOnContextChange"]});p.model._oHashData.controlPropertyObservers.push(o);if(p.vmControl.getResetOnContextChange()!==false){p.vmControl.attachEvent(k,{model:p.model},l);}},clearAllVariantURLParameters:function(p){j.update({updateURL:true,parameters:[],updateHashEntry:false,model:p.model});}};return j;},true);

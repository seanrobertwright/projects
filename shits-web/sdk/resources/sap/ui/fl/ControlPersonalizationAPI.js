/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/FlexControllerFactory","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/base/ManagedObject","sap/base/util/includes","sap/ui/fl/variants/VariantManagement","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/Component","sap/base/Log","sap/ui/thirdparty/jquery"],function(L,U,a,C,F,J,E,M,i,V,b,c,d,q){"use strict";var e={_determineParameters:function(o,I){var A=U.getAppComponentForControl(o);var f=F.createForControl(A);var r=A.getRootControl();var p={rootControl:r,flexController:f};if(!I){var v;var g;p.variantModel=A.getModel(U.VARIANT_MODEL_NAME);p.variantManagement={};q.makeArray(p.rootControl.$().find(".sapUiFlVarMngmt")).map(function(h){v=sap.ui.getCore().byId(h.id);if(v.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){g=v.getFor();g.forEach(function(s){p.variantManagement[s]=p.variantModel.getLocalId(h.id,A);});}});}return p;},_getVariantManagement:function(o,p){p=p||this._determineParameters(o);var f=function(o){if(!p.variantManagement[o.getId()]&&o.getParent()&&o.getId()!==p.rootControl.getId()){return f(o.getParent());}else if(!o.getParent()||o.getId()===p.rootControl.getId()){return p.variantManagement[o.getId()]||"";}return p.variantManagement[o.getId()];};return f(o);},clearVariantParameterInURL:function(o){var u;var A=U.getAppComponentForControl(o);var v=A instanceof c?A.getModel(U.VARIANT_MODEL_NAME):undefined;if(!v){d.warning("Variant model could not be found on the provided control");}if(o instanceof V){var s=v.getLocalId(o.getId(),A);var m=b.removeURLParameterForVariantManagement({model:v,vmReference:s});u=m.parameters;}b.update({parameters:u||[],updateURL:true,updateHashEntry:!!v,model:v||{},silent:!v});},activateVariant:function(v,s){var o;return Promise.resolve().then(function(){if(typeof v==='string'||v instanceof String){o=c.get(v);if(!(o instanceof c)){o=sap.ui.getCore().byId(v);if(!(o instanceof E)){throw new Error("No valid component or control found for the provided ID");}}}else if(v instanceof c||v instanceof E){o=v;}var A=U.getAppComponentForControl(o);if(!A){throw new Error("A valid variant management control or component (instance or ID) should be passed as parameter");}var f=A.getModel(U.VARIANT_MODEL_NAME);if(!f){throw new Error("No variant management model found for the passed control or application component");}var g=f.getVariantManagementReference(s).variantManagementReference;if(!g){throw new Error("A valid control or component, and a valid variant/ID combination are required");}return f.updateCurrentVariant(g,s,A);})["catch"](function(f){d.error(f);return Promise.reject(f);});},_checkChangeSpecificData:function(o,l){if(!o.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"));}if(!o.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"));}if(!(o.selectorControl instanceof E)){return Promise.reject(new Error("No valid selectorControl"));}var s=o.selectorControl.getMetadata().getName();var f=C.getInstance();return f.getChangeHandler(o.changeSpecificData.changeType,s,o.selectorControl,J,l);},addPersonalizationChanges:function(p){var s=[];var l=a.getCurrentLayer(true);var P=[];p.controlChanges.forEach(function(o){var m={};Object.assign(m,{developerMode:false,layer:l});function f(){return this._checkChangeSpecificData(o,l).then(function(){var g=this._determineParameters(o.selectorControl,p.ignoreVariantManagement);if(!p.ignoreVariantManagement){if(!o.changeSpecificData.variantReference){var v=this._getVariantManagement(o.selectorControl,g);if(v){var h=g.variantModel.oData[v].currentVariant;o.changeSpecificData.variantReference=h;}}}else{delete o.changeSpecificData.variantReference;}return g.flexController.createAndApplyChange(Object.assign(m,o.changeSpecificData),o.selectorControl);}.bind(this)).then(function(A){s.push(A);}).catch(function(g){return Promise.reject({change:o,message:g.message});});}P.push(f.bind(this));}.bind(this));return U.execPromiseQueueSequentially(P).then(function(){return s;});},isPersonalized:function(f,g){if(!f||f.length===0){return this._reject("At least one control ID has to be provided as a parameter");}var A=f[0].appComponent||U.getAppComponentForControl(f[0]);if(!A){return this._reject("App Component could not be determined");}var I=f.map(function(h){return h.id||h.getId();});var o=F.createForControl(A);return o.getComponentChanges({currentLayer:L.USER,includeCtrlVariants:true}).then(function(h){return h.filter(this._filterBySelectors.bind(this,A,I)).filter(this._filterByChangeType.bind(this,g)).some(this._ifValidFileType);}.bind(this));},_reject:function(m){d.error(m);return Promise.reject(m);},_filterBySelectors:function(A,I,o){var s=o.getSelector();var f=J.getControlIdBySelector(s,A);return i(I,f);},_filterByChangeType:function(f,o){return(Array.isArray(f)&&f.length>0)?i(f,o.getChangeType()):true;},_ifValidFileType:function(o){return o.getFileType()==="change";},resetChanges:function(f,g){if(!f||f.length===0){return this._reject("At least one control ID has to be provided as a parameter");}var A=f[0].appComponent||U.getAppComponentForControl(f[0]);if(!A){return this._reject("App Component could not be determined");}var s=f.map(function(v){var h=v.id||v.getId();var l=A.getLocalId(h);return l||h;});var o=F.createForControl(A);return o.resetChanges(L.USER,undefined,A,s,g);},saveChanges:function(f,m){if(!(m instanceof M)){var s="A valid sap.ui.base.ManagedObject instance is required as a parameter";d.error(s);return Promise.reject(s);}var p=e._determineParameters(m);var v=Object.keys(p.variantManagement).reduce(function(r,g){return r.concat([p.variantManagement[g]]);},[]);return p.flexController.saveSequenceOfDirtyChanges(f).then(function(r){p.variantModel.checkDirtyStateForControlModels(v);return r;});},hasVariantManagement:function(o){try{return!!this._getVariantManagement(o);}catch(f){d.error(f.message);return false;}}};return e;},true);

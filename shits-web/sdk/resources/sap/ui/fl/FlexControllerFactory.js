/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FlexController","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/variants/VariantModel","sap/base/Log","sap/ui/performance/Measurement"],function(F,U,L,a,A,b,V,c,M){"use strict";var d={};d._instanceCache={};d.create=function(C,s){s=s||U.DEFAULT_APP_VERSION;if(!d._instanceCache[C]){d._instanceCache[C]={};}var f=d._instanceCache[C][s];if(!f){f=new F(C,s);d._instanceCache[C][s]=f;}return f;};d.createForControl=function(C,m){try{var o=U.getAppComponentForControl(C);var s=U.getComponentClassName(o||C);var f=U.getAppVersionFromManifest(o?o.getManifest():m);return d.create(s,f);}catch(E){c.error(E.message,undefined,"sap.ui.fl.FlexControllerFactory");}};function e(r,C){if(U.getUshellContainer()){return Promise.resolve(r);}var R=window.sessionStorage.getItem("sap.ui.rta.restart."+L.CUSTOMER);if(R){var s=U.getComponentClassName(C);if(R!==s&&R!=="true"){c.error("an application component was started "+"which does not match the component for which the restart was triggered:\n"+"Triggering component: "+R+"\n"+"Started component: "+s);return Promise.resolve(r);}window.sessionStorage.removeItem("sap.ui.rta.restart."+L.CUSTOMER);return new Promise(function(f){sap.ui.getCore().loadLibrary("sap.ui.rta",{async:true}).then(function(){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(g){g({rootControl:C});f(r);});});});}return Promise.resolve(r);}d.getChangesAndPropagate=function(C,v){if(U.isApplicationComponent(C)){return b.initialize({componentId:v.id||C.getId(),asyncHints:v.asyncHints}).then(_.bind(this,C));}else if(U.isEmbeddedComponent(C)){var o=U.getAppComponentForControl(C);if(o){return Promise.resolve().then(function(){var E=o.getModel(U.VARIANT_MODEL_NAME);if(!E){return _(o);}return E;}).then(function(f){C.setModel(f,U.VARIANT_MODEL_NAME);});}}};function _(o){var m=o.getManifestObject();var f;f=d.createForControl(o,m);return f._oChangePersistence.loadChangesMapForComponent(o).then(function(g){var p=A.applyAllChangesForControl.bind(A,g,o,f);p._bIsSapUiFlFlexControllerApplyChangesOnControl=true;o.addPropagationListener(p);var v=new V({},f,o);o.setModel(v,U.VARIANT_MODEL_NAME);M.end("flexProcessing");return v;}).then(function(r){return e(r,o);});}return d;},true);

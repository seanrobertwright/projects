/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils"],function(C,S,U){"use strict";var _={};function a(v){return v.some(function(o){return o.versionNumber===0;});}function b(v,o){if(a(v)){v.shift();}v.splice(0,0,o);return v;}var V={};V.getVersions=function(p){var r=p.reference;var l=p.layer;if(_[r]&&_[r][l]){return Promise.resolve(_[r][l]);}return S.versions.load(p).then(function(v){_[r]=_[r]||{};_[r][l]=v;return _[r][l];});};V.clearInstances=function(){_={};};V.ensureDraftVersionExists=function(p){var r=U.normalizeReference(p.reference);var v=_[r][p.layer];if(!a(v)){_[r][p.layer].splice(0,0,{versionNumber:0});}};V.activateDraft=function(p){var v;return V.getVersions(p).then(function(c){var d=a(c);v=c;var o=C.getChangePersistenceForComponent(p.reference);var D=o.getDirtyChanges().length>0;if(D){return o.saveDirtyChanges(false,undefined,true);}if(!d&&!D){return Promise.reject("No draft exists");}}).then(function(){return S.versions.activate(p);}).then(function(o){return b(v,o);});};V.discardDraft=function(p){return V.getVersions(p).then(function(v){var d=false;if(p.updateState&&p.appComponent){var m=p.appComponent.getManifest();var A=U.getAppVersionFromManifest(m);var c=C.getChangePersistenceForComponent(p.reference,A);var D=c.getDirtyChanges();d=D.length>0;D.forEach(c.deleteChange,c);}if(!a(v)){return d;}return S.versions.discardDraft(p).then(function(){v.shift();return true;});});};return V;});

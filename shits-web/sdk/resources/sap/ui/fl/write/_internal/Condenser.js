/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/changes/Utils"],function(J,F,U){"use strict";var C={};var c="unclassified";var d={lastOneWins:_,reverse:e};function _(D,K,o){if(!D.has(K)){D.set(K,[]);}var a=D.get(K);a.pop();a.push(o);}function e(p,u,o){if(!p.has(u)){p.set(u,new Map());}var a=p.get(u);var b=Array.from(a.keys());if(b.length!==0&&b.indexOf(o.getChangeType())===-1){a.delete(b[0]);}else{_(a,o.getChangeType(),o);}}function f(a,o,b){if(!a.has(o.classificationType)){a.set(o.classificationType,new Map());}var p=a.get(o.classificationType);d[o.classificationType](p,o.uniqueKey,b);}function g(a,K,o){if(!a.has(K)){a.set(K,[]);}var b=a.get(K);b.push(o);}function h(a,o){var s=J.getControlIdBySelector(o.getSelector(),a);var b=sap.ui.getCore().byId(s);var p={modifier:J,appComponent:a,view:F.getViewForControl(b)};var n=U.getControlIfTemplateAffected(o,b,p);return U.getChangeHandler(o,n,p);}function i(a,b,o){return h(a,o).then(function(H){var n=H!==undefined&&typeof H.getCondenserInfo==="function"?H.getCondenserInfo(o):undefined;if(n!==undefined){f(b,n,o);}else{g(b,c,o);}});}function j(a,r,o){var s=o.getSelector().id;if(!r.has(s)){r.set(s,new Map());}var b=r.get(s);return i(a,b,o).then(function(){var K=Array.from(b.keys());if(K.length===0){r.delete(s);}});}function k(o,a){var K=Array.from(o.keys());K.forEach(function(s){var S=o.get(s);if(S instanceof Map){k(S,a);}else{S.forEach(function(b){a.push(b);});}});}function l(r){var R=[];k(r,R);return R;}function m(n,r){r.sort(function(a,b){return n.indexOf(a)-n.indexOf(b);});}C.condense=function(a,b){var r=new Map();return b.reduce(function(p,o){return p.then(j.bind(this,a,r,o));}.bind(this),Promise.resolve()).then(function(){var R=l(r);m(b,R);return R;});};return C;});

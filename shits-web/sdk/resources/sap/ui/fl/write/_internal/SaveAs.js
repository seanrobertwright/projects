/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/Utils","sap/base/Log","sap/ui/fl/Layer","sap/base/util/includes","sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/fl/registry/Settings"],function(A,D,C,U,L,a,i,m,_,S){"use strict";function b(p){return S.getInstance().then(function(s){if(!p.package&&(p.layer===a.VENDOR||(p.layer===a.CUSTOMER_BASE&&!s.isAtoEnabled()))){return Promise.reject("Package must be provided or is valid");}if(p.isForSmartBusiness&&(p.package!=='$TMP'&&p.package!=='')&&!p.transport&&!s.isAtoEnabled()){return Promise.reject("Transport must be provided");}if(p.isForSmartBusiness&&p.transport||(p.package==="$TMP")){return Promise.resolve({packageName:p.package,transport:p.transport});}return Promise.resolve({packageName:"",transport:""});});}function c(p,t){var T=t.transport?p.setTransportRequest(t.transport):Promise.resolve();return T.then(function(){if(t.packageName){return p.setPackage(t.packageName);}return Promise.resolve();});}function d(p){var I=[];p.forEach(function(q){var r=q.getDefinition();I.push(D.createNew(r.changeType,r.content,r.texts));});return Promise.all(I);}function e(p,q){var P={reference:q.getId()};var s=U.createNamespace(P,"changes");p.setNamespace(s);p.setComponent(q.getId());if(q.getVersion()){p.setValidAppVersions({creation:q.getVersion(),from:q.getVersion()});}}function f(p,q){var r=[];p.forEach(function(I){I.replaceHostingIdForTextKey(q.getId(),q.getReference(),I.getContent(),I.getTexts());r.push(q.addDescriptorInlineChange(I));});return Promise.all(r);}function g(s){var p=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;if(p){var q=p.getDirtyChanges();q=q.slice();return q;}return[];}function h(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;if(F){var u=F.getDirtyChanges();u=u.slice();return u;}return[];}function j(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;var p=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;return F===p;}function k(s,p,q){var r=[];if(p){g(s).forEach(function(t){if(i(D.getDescriptorChangeTypes(),t.getDefinition().changeType)){r.push(t);}else{e(t,q);}});}else{h(s).forEach(function(t){e(t,q);});r=g(s);}return r;}function l(s){g(s).forEach(function(p){if(i(D.getDescriptorChangeTypes(),p.getChangeType())){C.getDescriptorFlexControllerInstance(s)._oChangePersistence.deleteChange(p);}});}function n(p,P){if(!p){throw new Error("App variant with ID: "+P.id+"does not exist");}P.package=p.getPackage();P.layer=p.getDefinition().layer;return b(P).then(function(t){return c(p,t);}).then(function(){return p;});}var o={saveAs:function(p){var q;var r;var s=false;return A.prepareCreate(p).then(function(t){q=m({},t);return b(p);}).then(function(t){return c(q,t);}).then(function(){s=j(p.selector);var t=k(p.selector,s,q);return d(t);}).then(function(t){return f(t,q);}).then(function(){return q.submit().catch(function(E){E.messageKey="MSG_SAVE_APP_VARIANT_FAILED";throw E;});}).then(function(R){r=m({},R);if(s){l(p.selector);}var F=C.getFlexControllerInstance(p.selector);var u=h(p.selector);if(u.length){return F.saveAll(true).catch(function(E){if(s){l(p.selector);}return this.deleteAppVariant({id:p.id}).then(function(){E.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw E;});}.bind(this));}return Promise.resolve();}.bind(this)).then(function(){if(!s){l(p.selector);}return r;}).catch(function(E){if(g(p.selector).length){l(p.selector);}L.error("the app variant could not be created.",E.message||E);throw E;});},updateAppVariant:function(p){var q;var r;return A.prepareUpdate(_(p,"selector")).catch(function(E){E.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw E;}).then(function(s){if(!s){throw new Error("App variant with ID: "+p.id+"does not exist");}q=m({},s);p.package=q.getPackage();p.layer=q.getDefinition().layer;return b(p);}).then(function(t){return c(q,t);}).then(function(){var s=[];g(p.selector).forEach(function(t){if(i(D.getDescriptorChangeTypes(),t.getDefinition().changeType)){s.push(t);}});return d(s);}).then(function(s){return f(s,q);}).then(function(){return q.submit().catch(function(E){if(p.isForSmartBusiness){l(p.selector);throw E;}E.messageKey="MSG_UPDATE_APP_VARIANT_FAILED";throw E;});}).then(function(R){r=m({},R);l(p.selector);return r;}).catch(function(E){if(g(p.selector).length){l(p.selector);}L.error("the app variant could not be updated.",E.message||E);throw E;});},deleteAppVariant:function(p){return A.prepareDelete(_(p,"selector")).catch(function(E){E.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw E;}).then(function(q){return((p.isForSmartBusiness)?Promise.resolve(q):n(q,p));}).then(function(q){return q.submit().catch(function(E){if(E==="cancel"){return Promise.reject("cancel");}E.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw E;});}).catch(function(E){if(E==="cancel"){return Promise.reject("cancel");}L.error("the app variant could not be deleted.",E.message||E);throw E;});}};return o;},true);

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log","sap/base/util/restricted/_uniqWith"],function(C,U,L,a,V,b,c,A,R,d,J,X,e,f,_){"use strict";var F=function(s,g){this._oChangePersistence=undefined;this._sComponentName=s||"";this._sAppVersion=g||U.DEFAULT_APP_VERSION;if(this._sComponentName&&this._sAppVersion){this._createChangePersistence();}};F.prototype.setComponentName=function(s){this._sComponentName=s;this._createChangePersistence();};F.prototype.getComponentName=function(){return this._sComponentName;};F.prototype.getAppVersion=function(){return this._sAppVersion;};F.prototype.getVariantModelData=function(){var D;if(this._oChangePersistence&&this._oChangePersistence._oVariantController._mVariantManagement&&Object.keys(this._oChangePersistence._oVariantController._mVariantManagement).length>0){D=this._oChangePersistence._oVariantController.fillVariantModel();}return D;};F.prototype.setVariantSwitchPromise=function(p){this._oVariantSwitchPromise=p;};F.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve();}return this._oVariantSwitchPromise;};F.prototype.createBaseChange=function(o,g){var h;var i;if(!g){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.");}o.reference=this.getComponentName();o.packageName="$TMP";o.validAppVersions=U.getValidAppVersions({appVersion:this.getAppVersion(),developerMode:o.developerMode,scenario:o.scenario});h=a.createInitialFileContent(o);i=new a(h);if(o.variantReference){i.setVariantReference(o.variantReference);}return i;};F.prototype._createChange=function(o,g,h){var s=h&&(h.controlType||U.getControlType(h));var i=this.createBaseChange(o,g);return this._getChangeHandler(i,s,h,J).then(function(j){if(j){j.completeChangeContent(i,o,{modifier:J,appComponent:g});}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(o)+".");}return i;}).catch(function(E){return Promise.reject(E);});};F.prototype.createChangeWithExtensionPointSelector=function(o,E){return Promise.resolve().then(function(){if(!E){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.");}var v=E.view;var g=U.getAppComponentForControl(v);o.selector={name:E.name,viewSelector:J.getSelector(v.getId(),g)};return g;}).then(function(g){return this._createChange(o,g);}.bind(this));};F.prototype.createChangeWithControlSelector=function(o,g){var h;return new U.FakePromise().then(function(){if(!g){throw new Error("A flexibility change cannot be created without a targeted control.");}var s=g.id||g.getId();if(!o.selector){o.selector={};}h=g.appComponent||U.getAppComponentForControl(g);if(!h){throw new Error("No application component found. To offer flexibility, the control with the ID '"+s+"' has to have a valid relation to its owning application component.");}Object.assign(o.selector,J.getSelector(s,h));return h;}).then(function(h){return this._createChange(o,h,g);}.bind(this));};F.prototype.createVariant=function(v,o){var g;var h;if(!o){throw new Error("No Application Component found - to offer flexibility the variant has to have a valid relation to its owning application component.");}if(v.content.variantManagementReference){var i=J.checkControlId(v.content.variantManagementReference,o);if(!i){throw new Error("Generated ID attribute found - to offer flexibility a stable VariantManagement ID is needed to assign the changes to, but for this VariantManagement control the ID was generated by SAPUI5 "+v.content.variantManagementReference);}}v.content.reference=this.getComponentName();v.content.packageName="$TMP";v.content.validAppVersions=U.getValidAppVersions(this.getAppVersion(),v.developerMode,v.scenario);h=V.createInitialFileContent(v);g=new V(h);return g;};F.prototype.addChange=function(o,g){return this.createChangeWithControlSelector(o,g).then(function(h){var i=U.getAppComponentForControl(g);h._ignoreOnce=true;this.addPreparedChange(h,i);return h;}.bind(this));};F.prototype.addPreparedChange=function(o,g){if(o.getVariantReference()){var m=g.getModel(U.VARIANT_MODEL_NAME);m.addChange(o);}this._oChangePersistence.addChange(o,g);return o;};F.prototype.deleteChange=function(o,g){this._oChangePersistence.deleteChange(o);if(o.getVariantReference()){g.getModel(U.VARIANT_MODEL_NAME).removeChange(o);}};F.prototype.createAndApplyChange=function(o,g){var h;return this.addChange(o,g).then(function(i){h=i;var p={modifier:J,appComponent:U.getAppComponentForControl(g),view:U.getViewForControl(g)};h.setQueuedForApply();return A.applyChangeOnControl(h,g,p);}).then(function(r){if(!r.success){var E=r.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(h,true);throw E;}return h;}.bind(this));};F.prototype._checkDependencies=function(o,D,m,g,r){var h=this._canChangePotentiallyBeApplied(o,g);if(!h){return[];}r.push(o);var s=o.getId();var j=D[s]&&D[s].dependencies||[];for(var i=0,n=j.length;i<n;i++){var k=U.getChangeFromChangesMap(m,j[i]);h=this._checkDependencies(k,D,m,g,r);if(h.length===0){r=[];break;}delete D[s];}return r;};F.prototype._canChangePotentiallyBeApplied=function(o,g){var s=o.getDependentControlSelectorList();s.push(o.getSelector());return!s.some(function(S){return!J.bySelector(S,g);});};F.prototype.waitForChangesToBeApplied=function(s){var S;if(Array.isArray(s)){S=s;}else{S=[s];}var p=S.map(function(v){return this._waitForChangesToBeApplied(v);}.bind(this));return Promise.all(p).then(function(){return undefined;});};F.prototype._waitForChangesToBeApplied=function(s){var o=s.id&&sap.ui.getCore().byId(s.id)||s;var m=this._oChangePersistence.getChangesMapForComponent();var p=[];var D=Object.assign({},m.mDependencies);var g=m.mChanges;var h=g[o.getId()]||[];var n=h.filter(function(j){return!j.isCurrentProcessFinished();},this);var i=s.appComponent||U.getAppComponentForControl(o);var r=[];n.forEach(function(j){var k=this._checkDependencies(j,D,m.mChanges,i,[]);k.forEach(function(l){if(r.indexOf(l)===-1){r.push(l);}});}.bind(this));r.forEach(function(j){p=p.concat(j.addChangeProcessingPromises());},this);p.push(this.waitForVariantSwitch());return Promise.all(p);};F.prototype.saveAll=function(s,D){return this._oChangePersistence.saveDirtyChanges(s,undefined,D).then(function(r){if(D&&r&&r.response){var v=r.response;if(Array.isArray(v)){v=v[0];}c.ensureDraftVersionExists({reference:v.reference,layer:v.layer});}return r;});};F.prototype.processXmlView=function(v,p){var o=e.get(p.componentId);var g=U.getAppComponentForControl(o);p.appComponent=g;p.modifier=X;p.view=v;return this._oChangePersistence.getChangesForView(p).then(A.applyAllChangesForXMLView.bind(A,p)).catch(this._handlePromiseChainError.bind(this,p.view));};F.prototype._handlePromiseChainError=function(v,E){f.error("Error processing view "+E+".");return v;};F.prototype._getSelectorOfChange=function(o){if(!o||!o.getSelector){return undefined;}return o.getSelector();};F.prototype._getChangeHandler=function(o,s,g,m){var h=o.getChangeType();var l=o.getLayer();return this._getChangeRegistry().getChangeHandler(h,s,g,m,l);};F.prototype._getChangeRegistry=function(){var i=C.getInstance();i.initSettings();return i;};F.prototype.getComponentChanges=function(p,i){return this._oChangePersistence.getChangesForComponent(p,i);};F.prototype.checkForOpenDependenciesForControl=function(s,o){return this._oChangePersistence.checkForOpenDependenciesForControl(s,o);};F.prototype.hasHigherLayerChanges=function(p){p=p||{};var s=p.upToLayer||L.getCurrentLayer(false);p.includeVariants=true;p.includeCtrlVariants=true;return this.getComponentChanges(p).then(function(v){var h=v===this._oChangePersistence.HIGHER_LAYER_CHANGES_EXIST||v.some(function(o){return L.compareAgainstCurrentLayer(o.getLayer(),s)>0;});return!!h;}.bind(this));};F.prototype._createChangePersistence=function(){this._oChangePersistence=b.getChangePersistenceForComponent(this.getComponentName(),this.getAppVersion());return this._oChangePersistence;};F.prototype.resetChanges=function(l,g,o,s,h){return this._oChangePersistence.resetChanges(l,g,s,h).then(function(i){if(i.length!==0){return R.revertMultipleChanges(i,{appComponent:o,modifier:J,flexController:this});}}.bind(this)).then(function(){if(o){var m=o.getModel(U.VARIANT_MODEL_NAME);if(m){d.update({parameters:[],updateURL:true,updateHashEntry:true,model:m});}}});};F.prototype.discardChanges=function(g,D){var s=L.getCurrentLayer(!!D);var i=0;var l;var o;l=g.length;while(i<g.length){o=g[i];if(o&&o.getLayer&&o.getLayer()===s){this._oChangePersistence.deleteChange(o);}if(l===g.length){i++;}else{l=g.length;}}return this._oChangePersistence.saveDirtyChanges();};F.prototype.discardChangesForId=function(i,D){if(!i){return Promise.resolve();}var o=this._oChangePersistence.getChangesMapForComponent();var g=o.mChanges[i]||[];return this.discardChanges(g,D);};F.prototype.applyVariantChanges=function(g,o){var p=[];var m=J;var h=g.map(function(i){this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(o,i);return this._getSelectorOfChange(i);}.bind(this));var s=function(S,t){return S.id===t.id;};h=_(h,s);h.forEach(function(S){p.push(function(){var i=m.bySelector(S,o);if(!i){f.error("A flexibility change tries to change a nonexistent control.");return new U.FakePromise();}return A.applyAllChangesForControl(this._oChangePersistence.getChangesMapForComponent.bind(this._oChangePersistence),o,this,i);}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};F.prototype.saveSequenceOfDirtyChanges=function(D){return this._oChangePersistence.saveDirtyChanges(false,D);};F.prototype.getResetAndPublishInfo=function(p){p.reference=this._sComponentName;p.appVersion=this._sAppVersion;return this._oChangePersistence.getResetAndPublishInfo(p);};return F;},true);

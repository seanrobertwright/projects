/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/base/util/merge","sap/base/util/includes","sap/base/util/ObjectPath","sap/ui/fl/apply/_internal/flexState/FlexState","sap/base/util/isEmptyObject"],function(J,a,B,L,U,b,C,c,R,d,f,i,O,F,e){"use strict";function _(){var v=Object.keys(this.oData);v.forEach(function(s){var p={variantManagementReference:s,currentVariantReference:this.oData[s].currentVariant||this.oData[s].defaultVariant,newVariantReference:true};var m=this.oChangePersistence.loadSwitchChangesMapForComponent(p);k(R.revertMultipleChanges.bind(null,m.changesToBeReverted,{appComponent:this.oAppComponent,modifier:a,flexController:this.oFlexController}),this,s).then(function(){delete this.oData[s];delete this.oVariantController.getChangeFileContent()[s];this._ensureStandardVariantExists(s);}.bind(this));}.bind(this));d.initialize({model:this});d.update({parameters:[],updateHashEntry:true,model:this});return this._oVariantSwitchPromise;}function g(E,p){return k(function(P,v){var m=v.model;var s=v.vmReference;var l=false;var t=P.key;var S=P.key;return Promise.resolve().then(function(){if(O.get([s,"currentVariant"],m.oData)&&m.oData[s].currentVariant!==m.oData[s].originalCurrentVariant){S=m.oData[s].originalCurrentVariant;l=true;return m.updateCurrentVariant(s,t,m.oAppComponent,true);}}).then(function(){if(O.get([s,"modified"],m.oData)===true){var n=m.oVariantController.getVariantChanges(s,S,true);return h({changes:n,vmReference:s,vReference:S,revert:!l,model:m}).then(function(){m.oData[s].originalCurrentVariant=t;m.oData[s].modified=false;m.checkUpdate(true);});}});}.bind(null,E.getParameters(),p),p.model,p.vmReference);}function h(p){var v=p.model._getDirtyChangesFromVariantChanges(p.changes);return Promise.resolve().then(function(){if(p.revert){return R.revertMultipleChanges(v,{appComponent:p.model.oAppComponent,modifier:a,flexController:p.model.oFlexController});}}).then(function(){v.forEach(function(o){p.model.oVariantController.removeChangeFromVariant(o,p.vmReference,p.vReference);p.model.oFlexController.deleteChange(o,p.model.oAppComponent);});});}function j(m,v,l){m.oData[v].variantBusy=l;m.checkUpdate();}function k(l,m,v){m._oVariantSwitchPromise=m._oVariantSwitchPromise.catch(function(){}).then(j.bind(null,m,v,true)).then(l).then(j.bind(null,m,v,false)).catch(function(E){j(m,v,false);throw E;});m.oFlexController.setVariantSwitchPromise(m._oVariantSwitchPromise);return m._oVariantSwitchPromise;}var V=J.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,o,A,l){this.pSequentialImportCompleted=Promise.resolve();J.apply(this,arguments);this.bObserve=l;if(!o){o=sap.ui.requireSync("sap/ui/fl/FlexControllerFactory").createForControl(A);}this.oFlexController=o;this.oChangePersistence=this.oFlexController._oChangePersistence;this.oVariantController=this.oChangePersistence._oVariantController;this.oAppComponent=A;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this.oVariantController.assignResetMapListener(_.bind(this));if(e(D)){D=this.oVariantController.fillVariantModel();}if(D&&typeof D==="object"){Object.keys(D).forEach(function(K){D[K].variants.forEach(function(v){if(!D[K].currentVariant&&(v.key===D[K].defaultVariant)){D[K].currentVariant=v.key;}v.originalTitle=v.title;v.originalFavorite=v.favorite;v.originalVisible=v.visible;});D[K].originalCurrentVariant=D[K].currentVariant;D[K].originalDefaultVariant=D[K].defaultVariant;});this.setData(D);}d.initialize({model:this});}});V.prototype.updateCurrentVariant=function(v,n,A,I){var s=this.oData[v].originalCurrentVariant;var p={variantManagementReference:v,currentVariantReference:s,newVariantReference:n};var S=function(p){var m=this.oChangePersistence.loadSwitchChangesMapForComponent(p);return R.revertMultipleChanges(m.changesToBeReverted,{appComponent:A||this.oAppComponent,modifier:a,flexController:this.oFlexController}).then(this.oFlexController.applyVariantChanges.bind(this.oFlexController,m.changesToBeApplied,A||this.oAppComponent)).then(function(){this.oData[v].originalCurrentVariant=n;this.oData[v].currentVariant=n;if(this.oData[v].updateVariantInURL){d.updateVariantInURL({vmReference:v,newVReference:n,model:this});this.oVariantController.updateCurrentVariantInMap(v,n);}this.checkUpdate();}.bind(this));}.bind(this,p);if(I){return S();}return k(S,this,v);};V.prototype.getCurrentVariantReference=function(v){return this.oData[v].currentVariant;};V.prototype.getVariantManagementReference=function(v){var s="";var I=-1;Object.keys(this.oData).some(function(K){return this.oData[K].variants.some(function(o,l){if(o.key===v){s=K;I=l;return true;}});}.bind(this));return{variantManagementReference:s,variantIndex:I};};V.prototype.getVariant=function(v,s){return this.oVariantController.getVariant(s||this.getVariantManagementReference(v).variantManagementReference,v);};V.prototype.getVariantProperty=function(v,p){return this.getVariant(v).content.content[p];};V.prototype.addChange=function(o){var v=o.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;this.oData[s].modified=!!this.oData[s].variantsEditable;this.checkUpdate(true);return this.oVariantController.addChangeToVariant(o,s,v);};V.prototype.removeChange=function(o){var v=o.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;return this.oVariantController.removeChangeFromVariant(o,s,v);};V.prototype._getVariantTitleCount=function(n,v){var D=this.getData();return D[v].variants.reduce(function(l,o){if(n.toLowerCase()===o.title.toLowerCase()&&o.visible){l++;}return l;},0);};V.prototype._duplicateVariant=function(p){var n=p.newVariantReference;var s=p.sourceVariantReference;var v=p.variantManagementReference;var S=this.getVariant(s);var l=this.oVariantController.getVariantChanges(v,s,true).map(function(r){return r.getDefinition();});var D={content:{},controlChanges:l,variantChanges:{}};var m=b.compareAgainstCurrentLayer(S.content.layer,!this._bDesignTimeMode?L.USER:"");Object.keys(S.content).forEach(function(K){if(K==="fileName"){D.content[K]=n;}else if(K==="variantReference"){if(m===0){D.content[K]=S.content["variantReference"];}else if(m===-1){D.content[K]=s;}}else if(K==="content"){D.content[K]=JSON.parse(JSON.stringify(S.content[K]));D.content.content.title=p.title;}else{D.content[K]=S.content[K];}});D.content["layer"]=p.layer;l=D.controlChanges.slice();var o={};var q;D.controlChanges=l.reduce(function(r,t){if(b.compareAgainstCurrentLayer(t.layer,!this._bDesignTimeMode?L.USER:"")===0){o=f({},t);o.variantReference=D.content.fileName;if(!o.support){o.support={};}o.support.sourceChangeFileName=t.fileName;o.packageName="$TMP";q=C.createInitialFileContent(o);r.push(new C(q));}return r;}.bind(this),[]);return D;};V.prototype.copyVariant=function(p){var D=this._duplicateVariant(p);var v={key:D.content.fileName,layer:p.layer,title:D.content.content.title,originalTitle:D.content.content.title,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true};var o=this.oFlexController.createVariant(D,p.appComponent);var l=[];[o].concat(o.getControlChanges()).forEach(function(m){l.push(this.oChangePersistence.addDirtyChange(m));}.bind(this));var I=this.oVariantController.addVariantToVariantManagement(f({},o.getDefinitionWithChanges(),{content:{content:{visible:v.visible,favorite:v.favorite}}}),p.variantManagementReference);this.oData[p.variantManagementReference].variants.splice(I,0,v);return this.updateCurrentVariant(p.variantManagementReference,o.getId(),p.appComponent,true).then(function(){return l;});};V.prototype.removeVariant=function(p){var l=this.oChangePersistence.getDirtyChanges().filter(function(o){return(o.getVariantReference&&o.getVariantReference()===p.variant.getId())||o.getId()===p.variant.getId();});return this.updateCurrentVariant(p.variantManagementReference,p.sourceVariantReference,p.component).then(function(){var I=this.oVariantController.removeVariantFromVariantManagement(p.variant,p.variantManagementReference);this.oData[p.variantManagementReference].variants.splice(I,1);this.checkUpdate();l.forEach(function(o){this.oChangePersistence.deleteChange(o);}.bind(this));}.bind(this));};V.prototype.collectModelChanges=function(v,l){var D=this.getData()[v];var m=D.variants;var n=[];var p={};m.forEach(function(o){if(o.originalTitle!==o.title){p={variantReference:o.key,changeType:"setTitle",title:o.title,originalTitle:o.originalTitle,layer:l};n.push(p);}if(o.originalFavorite!==o.favorite){p={variantReference:o.key,changeType:"setFavorite",favorite:o.favorite,originalFavorite:o.originalFavorite,layer:l};n.push(p);}if(!o.visible&&o.originalVisible){p={variantReference:o.key,changeType:"setVisible",visible:false,layer:l};n.push(p);}});if(D.originalDefaultVariant!==D.defaultVariant){p={variantManagementReference:v,changeType:"setDefault",defaultVariant:D.defaultVariant,originalDefaultVariant:D.originalDefaultVariant,layer:l};n.push(p);}return n;};V.prototype.manageVariants=function(v,s,l,m){return new Promise(function(r){v.attachEventOnce("manage",{resolve:r,variantManagementReference:s,layer:l},this.fnManageClickRta,this);v.openManagementDialog(true,m);}.bind(this));};V.prototype.setVariantProperties=function(v,p,A){var l=-1;var o;var m=null;var D=this.getData();if(p.variantReference){l=this.getVariantManagementReference(p.variantReference).variantIndex;o=D[v].variants[l];}var n={};var q={};switch(p.changeType){case"setTitle":q.title=p.title;o.title=p.title;o.originalTitle=o.title;break;case"setFavorite":q.favorite=p.favorite;o.favorite=p.favorite;o.originalFavorite=o.favorite;break;case"setVisible":q.visible=p.visible;q.createdByReset=false;o.visible=p.visible;o.originalVisible=o.visible;break;case"setDefault":q.defaultVariant=p.defaultVariant;D[v].defaultVariant=p.defaultVariant;D[v].originalDefaultVariant=D[v].defaultVariant;var H=d.getStoredHashParams({model:this});if(H){if(D[v].defaultVariant!==D[v].currentVariant&&H.indexOf(D[v].currentVariant)===-1){d.update({parameters:H.concat(D[v].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(D[v].defaultVariant===D[v].currentVariant&&H.indexOf(D[v].currentVariant)>-1){H.splice(H.indexOf(D[v].currentVariant),1);d.update({parameters:H,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(!A&&D[v].currentVariant!==p.defaultVariant){this.updateCurrentVariant(v,p.defaultVariant,p.appComponent);}break;default:break;}if(l>-1){var s=this.oVariantController._setVariantData(q,v,l);D[v].variants.splice(l,1);D[v].variants.splice(s,0,o);}else if(this.oVariantController._mVariantManagement[v]){this.oVariantController._mVariantManagement[v].defaultVariant=p.defaultVariant;}if(A===true){n.changeType=p.changeType;n.layer=p.layer;if(p.changeType==="setDefault"){n.fileType="ctrl_variant_management_change";n.selector=a.getSelector(v,p.appComponent);}else{if(p.changeType==="setTitle"){c.setTextInChange(n,"title",p.title,"XFLD");}n.fileType="ctrl_variant_change";n.selector=a.getSelector(p.variantReference,p.appComponent);}m=this.oFlexController.createBaseChange(n,p.appComponent);m.setContent(q);this.oVariantController._updateChangesForVariantManagementInMap(m.getDefinition(),v,true);this.oChangePersistence.addDirtyChange(m);}else{if(p.change){this.oVariantController._updateChangesForVariantManagementInMap(p.change.getDefinition(),v,false);this.oChangePersistence.deleteChange(p.change);}}this.setData(D);this.checkUpdate(true);return m;};V.prototype._ensureStandardVariantExists=function(v){if(!this.oVariantController){throw new Error("An sap.ui.fl.variants.VariantController instance was not found.");}var D=this.getData();if(!D[v]){D[v]={currentVariant:v,originalCurrentVariant:v,defaultVariant:v,originalDefaultVariant:v,variants:[{key:v,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,visible:true,originalVisible:true,author:this.oVariantController.DEFAULT_AUTHOR}]};this.setData(D);var o={changes:{variantSection:{}}};var l={defaultVariant:v,variantManagementChanges:{},variants:[{content:{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",support:{user:this.oVariantController.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true}},controlChanges:[],variantChanges:{}}]};o.changes.variantSection[v]=l;this.oVariantController.setChangeFileContent(o,{});}};V.prototype.setModelPropertiesForControl=function(v,D,o){var r=function(m,v,D){if((m.layer===b.getCurrentLayer(!D))&&(m.key!==v)){return true;}return false;};this.oData[v].modified=false;this.oData[v].showFavorites=true;var l=this._bDesignTimeMode;if(l!==D){this._bDesignTimeMode=D;if(D){d.clearAllVariantURLParameters({model:this});}else if(l){d.update({parameters:d.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}o.detachManage(this.fnManageClick,this);if(D){this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(m){m.rename=true;m.change=true;m.remove=r(m,v,D);});}else{if(this.oData[v]._isEditable){o.attachManage({variantManagementReference:v},this.fnManageClick,this);this.oData[v].variantsEditable=true;this.oData[v].variants.forEach(function(m){m.remove=r(m,v,D);if(m.layer===b.getCurrentLayer(true)){m.rename=true;m.change=true;}else{m.rename=false;m.change=false;}});}else{this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(m){m.remove=false;m.rename=false;m.change=false;});}}};V.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var l=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(l);};this.fnManageClick=function(E,D){if(!this.oFlexController||!this.oVariantController){return;}var l=this.collectModelChanges(D.variantManagementReference,b.getCurrentLayer(true));l.forEach(function(o){o.appComponent=this.oAppComponent;this.setVariantProperties(D.variantManagementReference,o,true);}.bind(this));this.oChangePersistence.saveDirtyChanges();};};V.prototype._handleSave=function(E){var v=E.getSource();var A=U.getAppComponentForControl(v);var s=this.getLocalId(v.getId(),A);return k(function(l,A,p){var S=p["def"];var m=this.getCurrentVariantReference(l);var n=this.oVariantController.getVariantChanges(l,m,true);if(p["overwrite"]){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(n)).then(function(r){this.checkDirtyStateForControlModels([l]);return r;}.bind(this));}var N=U.createDefaultFileName();var P={variantManagementReference:l,appComponent:A,layer:b.getCurrentLayer(true),title:p["name"],sourceVariantReference:m,newVariantReference:N};return this.copyVariant(P).then(function(o){if(S){var q={changeType:"setDefault",defaultVariant:N,originalDefaultVariant:this.oData[l].defaultVariant,appComponent:A,layer:b.getCurrentLayer(true),variantManagementReference:l};var r=this.setVariantProperties(l,q,true);o.push(r);}this.oData[l].modified=false;this.checkUpdate(true);return h({changes:n,vmReference:l,vReference:m,model:this}).then(this.oFlexController.saveSequenceOfDirtyChanges.bind(this.oFlexController,o));}.bind(this));}.bind(this,s,A,E.getParameters()),this,s);};V.prototype.getLocalId=function(I,A){return a.getSelector(I,A).id;};V.prototype.getVariantManagementReferenceForControl=function(v){var s=v.getId();var A=U.getAppComponentForControl(v);return(A&&A.getLocalId(s))||s;};V.prototype.switchToDefaultForVariantManagement=function(v){if(this.oData[v].currentVariant!==this.oData[v].defaultVariant){B.show(200);this.updateCurrentVariant(v,this.oData[v].defaultVariant).then(function(){B.hide();});}};V.prototype.switchToDefaultForVariant=function(v){Object.keys(this.oData).forEach(function(s){if(!v||this.oData[s].currentVariant===v){this.switchToDefaultForVariantManagement(s);}}.bind(this));};V.prototype.registerToModel=function(v){var s=this.getVariantManagementReferenceForControl(v);this._ensureStandardVariantExists(s);this.oData[s]._isEditable=v.getEditable();v.attachEvent("select",{vmReference:s,model:this},g);v.attachSave(this._handleSave,this);this.setModelPropertiesForControl(s,false,v);var u=v.getUpdateVariantInURL();this.oData[s].updateVariantInURL=u;d.registerControl({vmReference:s,updateURL:!!u,model:this});d.handleModelContextChange({model:this,vmControl:v});};V.prototype._getDirtyChangesFromVariantChanges=function(l){var m=l.map(function(o){return o.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(o){return i(m,o.getId());});};V.prototype.checkDirtyStateForControlModels=function(v){v.forEach(function(s){var m=this.oData[s];if(m.modified===true){var l=this.getCurrentVariantReference(s);var n=this.oVariantController.getVariantChanges(s,l,true);var D=this._getDirtyChangesFromVariantChanges(n);if(D.length===0){m.modified=false;}}}.bind(this));this.checkUpdate(true);};V.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(l,v){return l.concat([this.oData[v].currentVariant]);}.bind(this),[]);};return V;},true);

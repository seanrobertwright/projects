/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/base/util/UriParameters","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/base/util/merge"],function(F,L,A,B,U,S,a,m){"use strict";var o;var b;var r;var c;var _;var g=function(){return F.getAppDescriptor(r);};var G=function(){return S.getInstance();};var s=function(){window.onbeforeunload=_;};var f=function(C){var M=C?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";_=window.onbeforeunload;window.onbeforeunload=A.handleBeforeUnloadEvent;return A.showMessage(M);};var t=function(i,j){return b.triggerCatalogPublishing(i,j,true);};var T=function(i){return b.triggerCatalogPublishing(i,null,false);};var R=function(i,C){if(o){A.closeOverviewDialog();return this.onGetOverview(true,C);}else if(!o&&i){B.hide();return this.onGetOverview(true,C);}return Promise.resolve();};var d=function(i,I,C){return i?A.navigateToFLPHomepage():R.call(this,!I,C);};var e=function(i,j){if(i&&i.response&&i.response.IAMId){return b.notifyKeyUserWhenPublishingIsReady(i.response.IAMId,j,true);}return Promise.resolve();};var h=function(i,j){if(i&&i.response&&i.response.IAMId&&i.response.inProgress){return b.notifyKeyUserWhenPublishingIsReady(i.response.IAMId,j,false);}return Promise.resolve();};sap.ui.getCore().getEventBus().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(o){o.destroy();o=null;}});return{onGetOverview:function(i,l){var D=g();return new Promise(function(j){var C=function(){A.closeOverviewDialog();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantOverviewDialog"],function(k){if(!o){o=new k({idRunningApp:D["sap.app"].id,isOverviewForKeyUser:i,layer:l});}o.attachCancel(C);o.oPopup.attachOpened(function(){j(o);});o.open();});});},isOverviewExtended:function(){var u=U.fromQuery(window.location.search);var M=u.get("sap-ui-xx-app-variant-overview-extended");if(!M){return false;}return M.toLowerCase()==='true';},isManifestSupported:function(){var D=g();return A.getManifirstSupport(D["sap.app"].id).then(function(i){return i.response;}).catch(function(E){var i=A.buildErrorInfo("MSG_APP_VARIANT_FEATURE_FAILED",E);i.overviewDialog=true;return A.showRelevantDialog(i,false);});},isPlatFormEnabled:function(i,C,l){r=i;c=l;var D=g();if(D["sap.app"]&&D["sap.app"].id){if(F.getUshellContainer()&&!A.isStandAloneApp()&&C===L.CUSTOMER){var I;if(D["sap.app"].crossNavigation&&D["sap.app"].crossNavigation.inbounds){I=A.getInboundInfo(D["sap.app"].crossNavigation.inbounds);}else{I=A.getInboundInfo();}if(I){return true;}}}return false;},getAppVariantDescriptor:function(i){r=i;var D=g();if(D["sap.app"]&&D["sap.app"].id){return a.load({id:D["sap.app"].id});}return Promise.resolve(false);},onSaveAs:function(i,C,j,k){var I;var l;var D=g();if(k&&k["sap.app"].id===D["sap.app"].id){C=true;D=m({},k);k=null;}return new Promise(function(n){var p=function(){return b.processSaveAsDialog(D,i);};var q=function(H){B.show();return b.createAllInlineChanges(H);};var u=function(H){var J=H.slice();return A.addChangesToPersistence(J,r);};var v=function(){var H=A.getNewAppVariantId();return b.createAppVariant(H).catch(function(J){var M=J.messageKey;if(!M){M="MSG_SAVE_APP_VARIANT_FAILED";}return A.catchErrorDialog(J,M,H);});};var w=function(H){l=null;l=m({},H.response);return b.clearRTACommandStack(C);};var x=function(){var H=F.getUshellContainer();if(H&&C){H.setDirtyFlag(false);}};var y=function(H){x();I=A.isS4HanaCloud(H);var J=A.buildSuccessInfo(l.id,i,I);return b.showSuccessMessage(J);};var z=function(){var H=A.buildFinalSuccessInfoS4HANACloud();return b.showSuccessMessage(H);};var E=function(){B.show();if(I){var H;return f().then(function(){return t(l.id,l.reference);}).then(function(J){H=Object.assign({},J);B.hide();return d.call(this,i,null,j);}.bind(this)).then(function(){return e(H,l.id);}).then(function(){return z();}).then(function(){s();return i?n():d.call(this,i,I,j);}.bind(this));}B.hide();return d.call(this,i,I,j);};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(H){if(!b){b=new H({rootControl:r,commandSerializer:c,layer:j});}return p().then(q).then(u).then(v).then(w).then(G).then(y).then(E.bind(this)).then(n).catch(function(J){if(!J){return false;}if(I){s();}return d.call(this,null,I,j).then(n);}.bind(this));}.bind(this));}.bind(this));},onDeleteFromOverviewDialog:function(i,C,j){var I;return new Promise(function(k){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(l){if(!b){b=new l({rootControl:r,commandSerializer:c,layer:j});}var D=function(){return b.deleteAppVariant(i).catch(function(E){if(E==='cancel'){return Promise.reject("cancel");}var M=E.messageKey;if(!M){M="MSG_DELETE_APP_VARIANT_FAILED";}return A.catchErrorDialog(E,M,i);});};var n=function(){A.closeOverviewDialog();var u=A.buildDeleteSuccessMessage(i,I);return b.showSuccessMessage(u);};var p=function(u){I=A.isS4HanaCloud(u);if(I){var v;return f(C).then(function(){return T(i);}).then(function(w){v=Object.assign({},w);return R.call(this,!C,j);}.bind(this)).then(function(){return h(v,i);});}B.show();return Promise.resolve();};var q=function(){if(I){s();}B.hide();return C?k():R.call(this,!I,I,j).then(k);};if(C){A.closeOverviewDialog();A.navigateToFLPHomepage();}return G().then(p.bind(this)).then(D).then(n).then(q.bind(this)).catch(function(E){if(E==='cancel'){return false;}if(I){s();}return R.call(this,null,I,j).then(k);}.bind(this));}.bind(this));}.bind(this));}};});

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/variants/VariantManagement","sap/ui/base/ManagedObject","sap/m/delegate/ValueStateMessage","sap/ui/rta/command/CompositeCommand","sap/base/Log"],function(P,R,U,E,O,a,D,f,L,V,M,b,C,c){"use strict";E.prototype._variantManagement=undefined;E.prototype.getVariantManagement=function(){return this._variantManagement;};E.prototype.setVariantManagement=function(k){this._variantManagement=k;};E.prototype.hasVariantManagement=function(){return!!this._variantManagement;};function d(o){var m=o.getElement().getManageDialog();if(m&&!m.bIsDestroyed){m.destroy();}}var e=P.extend("sap.ui.rta.plugin.ControlVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:"string",variantManagementControlOverlay:{type:"any"}},associations:{},events:{}}});e.prototype.registerElementOverlay=function(o){var g=o.getElement();var v;P.prototype.registerElementOverlay.apply(this,arguments);if(g instanceof V){var A=g.getFor();var h;var i=f.getAppComponentForControl(g);var s=g.getId();v=i.getLocalId(s)||s;if(!A||(Array.isArray(A)&&A.length===0)){o.setVariantManagement(v);return;}h=!Array.isArray(A)?[A]:A;h.forEach(function(j){var k=j instanceof M?j:sap.ui.getCore().byId(j);var l=O.getOverlay(k);this._propagateVariantManagement(l,v);}.bind(this));o.attachEvent("editableChange",R._manageClickEvent,this);d(o);}else if(!o.getVariantManagement()){v=this._getVariantManagementFromParent(o);if(v){o.setVariantManagement(v);o.attachEvent("editableChange",R._manageClickEvent,this);}}};e.prototype._isPersonalizationMode=function(){return this.getCommandFactory().getFlexSettings().layer===L.USER;};e.prototype._propagateVariantManagement=function(p,v){var g=[];p.setVariantManagement(v);g=a.getAllChildOverlays(p);g.forEach(function(o){g=g.concat(this._propagateVariantManagement(o,v));}.bind(this));return g;};e.prototype._getVariantManagementFromParent=function(o){var v=o.getVariantManagement();if(!v&&o.getParentElementOverlay()){return this._getVariantManagementFromParent(o.getParentElementOverlay());}return v;};e.prototype.deregisterElementOverlay=function(o){if(this._isVariantManagementControl(o)){d(o);}o.detachEvent("editableChange",R._manageClickEvent,this);o.detachBrowserEvent("click",R._onClick,this);this.removeFromPluginsList(o);P.prototype.deregisterElementOverlay.apply(this,arguments);};e.prototype._getVariantModel=function(o){var A=f.getAppComponentForControl(o);return A?A.getModel(f.VARIANT_MODEL_NAME):undefined;};e.prototype._isEditable=function(o){if(this._isPersonalizationMode()){return false;}return this._isVariantManagementControl(o)&&this.hasStableId(o);};e.prototype._isVariantManagementControl=function(o){var g=o.getElement();var A=g.getAssociation("for");return!!(A&&g instanceof V);};e.prototype.isVariantSwitchAvailable=function(o){return this._isVariantManagementControl(o);};e.prototype.isVariantSwitchEnabled=function(g){var o=g[0];var v=[];if(this._isVariantManagementControl(o)){var h=o.getElement();var s=o.getVariantManagement?o.getVariantManagement():undefined;if(!s){return false;}var m=this._getVariantModel(h);if(m){v=m.getData()[s].variants.reduce(function(r,j){if(j.visible){return r.concat(j);}return r;},[]);}var i=v.length>1;return i;}return false;};e.prototype.setDesignTime=function(o){R._setDesignTime.call(this,o);};e.prototype.isRenameAvailable=function(o){return this._isVariantManagementControl(o);};e.prototype.isRenameEnabled=function(g){return this._isVariantManagementControl(g[0]);};e.prototype.isVariantDuplicateAvailable=function(o){return this._isVariantManagementControl(o);};e.prototype.isVariantDuplicateEnabled=function(g){var o=g[0];var v=o.getVariantManagement?o.getVariantManagement():undefined;if(!v||!this._isVariantManagementControl(o)){return false;}return true;};e.prototype.isVariantConfigureAvailable=function(o){return this._isVariantManagementControl(o);};e.prototype.isVariantConfigureEnabled=function(g){return this._isVariantManagementControl(g[0]);};e.prototype.switchVariant=function(t,n,s){var o=t.getDesignTimeMetadata();var T=t.getElement();this.getCommandFactory().getCommandFor(T,"switch",{targetVariantReference:n,sourceVariantReference:s},o).then(function(S){this.fireElementModified({command:S});}.bind(this)).catch(function(m){throw D.createError("ControlVariant#switchVariant",m,"sap.ui.rta");});};e.prototype.renameVariant=function(g){var o=g[0];this.setVariantManagementControlOverlay(o);this.startEdit(o);};e.prototype.startEdit=function(v){var o=v.getElement();var g=v.getDesignTimeMetadata().getData().variantRenameDomRef;var h=o.getTitle();var p=h.getText();var H=R.startEdit.bind(this,{overlay:v,domRef:g,pluginMethodName:"plugin.ControlVariant.startEdit"});if(v._triggerDuplicate){var s=this._getVariantTitleForCopy(p,v.getVariantManagement(),this._getVariantModel(o).getData());o.getTitle().setText(s);if(v.hasStyleClass("sapUiRtaErrorBg")){H();}else{v.attachEventOnce("geometryChanged",function(){H();},this);}}else{H();}};e.prototype.stopEdit=function(r){if(this._oEditedOverlay._triggerDuplicate){if(!this._oEditedOverlay.hasStyleClass("sapUiRtaErrorBg")){delete this._oEditedOverlay._triggerDuplicate;}}R._stopEdit.call(this,r,"plugin.ControlVariant.stopEdit");};e.prototype._createDuplicateCommand=function(p){return this.getCommandFactory().getCommandFor(p.element,"duplicate",{sourceVariantReference:p.currentVariantReference,newVariantTitle:p.newVariantTitle},p.designTimeMetadata,p.variantManagementReference);};e.prototype._emitLabelChangeEvent=function(){var t=R._getCurrentEditableFieldText.call(this);var o=this._oEditedOverlay;var g=o.getDesignTimeMetadata();var r=o.getElement();var m=this._getVariantModel(r);var s;var v=o.getVariantManagement();var T=this.getOldValue()!==t;var n=T||o._triggerDuplicate;var i=n?m._getVariantTitleCount(t,v):0;var h=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var j=m.getCurrentVariantReference(v);o.removeStyleClass("sapUiRtaErrorBg");if(this._oValueStateMessage){this._oValueStateMessage.getPopup().attachEventOnce("closed",function(){r.$().css("z-index",1);this._oValueStateMessage.destroy();delete this._oValueStateMessage;},this);this._oValueStateMessage.close();}if(t==='\xa0'){s="BLANK_ERROR_TEXT";}else if(i>0){s="DUPLICATE_ERROR_TEXT";}else if(n){return this._createSetTitleCommand({text:t,element:r,designTimeMetadata:g,variantManagementReference:v}).then(function(S){if(o._triggerDuplicate){return this._createDuplicateCommand({currentVariantReference:j,designTimeMetadata:g,variantManagementReference:v,element:r,newVariantTitle:this.getOldValue()}).then(function(l){return new C({commands:[l]});}).then(function(l){return T?l.addCommand(S):l;});}return S;}.bind(this)).then(function(l){this.fireElementModified({command:l});}.bind(this)).catch(function(l){throw D.createError("ControlVariant#_emitLabelChangeEvent",l,"sap.ui.rta");});}else{c.info("Control Variant title unchanged");return Promise.resolve();}if(s){var k=h.getText(s);this._prepareOverlayForValueState(o,k);o.addStyleClass("sapUiRtaErrorBg");return Promise.resolve(U._showMessageBox("ERROR","BLANK_DUPLICATE_TITLE_TEXT",s).then(function(){var l=function(){this._oValueStateMessage=new b(o);this._oValueStateMessage.getPopup().attachEventOnce("opened",function(p){p.getSource()._deactivateFocusHandle();});this._oValueStateMessage.open();this.startEdit(o);}.bind(this);return l;}.bind(this)));}};e.prototype._getVariantTitleForCopy=function(s,v,o){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");var g=r.getText("VARIANT_COPY_SINGLE_TEXT").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace("\\{0\\}","(.*)");var h=r.getText("VARIANT_COPY_MULTIPLE_TEXT").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace("\\{0\\}","(.*)").replace("\\{1\\}","([0-9]+)");var i=new RegExp(g+"+");var j=new RegExp(h);var t;var I=h.lastIndexOf("(.*)")>h.lastIndexOf("([0-9]+)")?1:2;var k=(I===1)?2:1;var T=0;if(j.test(s)){t=j.exec(s)[k];}else{t=i.test(s)?i.exec(s)[1]:s;}var l=[];o[v].variants.forEach(function(m){if(m.visible){l=j.test(m.title)?j.exec(m.title):i.exec(m.title);if(!l){return;}if(l.length===3&&t===l[k]&&T<=parseInt(l[I])){T=l[I]?(parseInt(l[I])+1):T;}else if(l.length===2&&t===l[1]){T=T===0?1:T;}}});return T>0?r.getText("VARIANT_COPY_MULTIPLE_TEXT",[t,T]):r.getText("VARIANT_COPY_SINGLE_TEXT",[t]);};e.prototype._createSetTitleCommand=function(p){this._$oEditableControlDomRef.text(p.text);return this.getCommandFactory().getCommandFor(p.element,"setTitle",{newText:p.text},p.designTimeMetadata,p.variantManagementReference).catch(function(m){c.error("Error during rename : ",m);});};e.prototype._prepareOverlayForValueState=function(o,v){o.getValueState=function(){return"Error";};o.getValueStateText=function(){return v;};o.getDomRefForValueStateMessage=function(){return this.$();};};e.prototype.configureVariants=function(g){var o=g[0];var v=o.getElement();var s=o.getVariantManagement();var m=this._getVariantModel(v);var h=o.getDesignTimeMetadata();m.manageVariants(v,s,this.getCommandFactory().getFlexSettings().layer,U.getRtaStyleClassName()).then(function(i){return this.getCommandFactory().getCommandFor(v,"configure",{control:v,changes:i},h,s);}.bind(this)).then(function(i){this.fireElementModified({command:i});}.bind(this)).catch(function(i){throw D.createError("ControlVariant#configureVariants",i,"sap.ui.rta");});};e.prototype.getMenuItems=function(g){var o=g[0];var m=[];if(this.isRenameAvailable(o)){m.push({id:"CTX_VARIANT_SET_TITLE",text:sap.ui.getCore().getLibraryResourceBundle('sap.ui.rta').getText('CTX_RENAME'),handler:this.renameVariant.bind(this),enabled:this.isRenameEnabled.bind(this),rank:210,icon:"sap-icon://edit"});}if(this.isVariantDuplicateAvailable(o)){m.push({id:"CTX_VARIANT_DUPLICATE",text:sap.ui.getCore().getLibraryResourceBundle('sap.ui.rta').getText('CTX_VARIANT_DUPLICATE'),handler:function(g){g[0]._triggerDuplicate=true;this.renameVariant(g);}.bind(this),enabled:this.isVariantDuplicateEnabled.bind(this),rank:220,icon:"sap-icon://duplicate"});}if(this.isVariantConfigureAvailable(o)){m.push({id:"CTX_VARIANT_MANAGE",text:sap.ui.getCore().getLibraryResourceBundle('sap.ui.rta').getText('CTX_VARIANT_MANAGE'),handler:this.configureVariants.bind(this),enabled:this.isVariantConfigureEnabled.bind(this),startSection:true,rank:230,icon:"sap-icon://action-settings"});}if(this.isVariantSwitchAvailable(o)){var h=this._getVariantModel(o.getElement());var s=o.getVariantManagement();var S=h.getData()[s].variants.reduce(function(r,v){if(v.visible){var i=h.getData()[s].currentVariant===v.key;var I={id:v.key,text:v.title,icon:i?"sap-icon://accept":"blank",enabled:!i};return r.concat(I);}return r;},[]);m.push({id:"CTX_VARIANT_SWITCH_SUBMENU",text:sap.ui.getCore().getLibraryResourceBundle('sap.ui.rta').getText('CTX_VARIANT_SWITCH'),handler:function(g,p){var i=p.eventItem.data();var t=g[0];var n=i.key;var j=h.getData()[s].currentVariant;return this.switchVariant(t,n,j);}.bind(this),enabled:this.isVariantSwitchEnabled.bind(this),submenu:S,rank:240,icon:"sap-icon://switch-views"});}return m;};return e;});

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./../util/isAggregationTemplate","sap/ui/model/json/JSONModel","sap/m/Label","sap/ui/core/Fragment","sap/base/util/restricted/_merge","sap/ui/base/ManagedObjectObserver","sap/ui/integration/designtime/baseEditor/util/createPromise","sap/base/util/deepClone","sap/base/util/deepEqual"],function(C,i,J,L,F,_,M,c,d,a){"use strict";var B=C.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor",{metadata:{properties:{"renderLabel":{type:"boolean",defaultValue:true},"value":{type:"any"},"config":{type:"object"}},aggregations:{"_label":{type:"sap.m.Label",visibility:"hidden",multiple:false},"content":{type:"sap.ui.core.Control",multiple:false}},events:{beforeValueChange:{parameters:{path:{type:"string"},value:{type:"any"},nextValue:{type:"any"}}},valueChange:{parameters:{path:{type:"string"},value:{type:"any"},previousValue:{type:"any"}}},configChange:{parameters:{previousConfig:{type:"object"},config:{type:"object"}}},ready:{}}},xmlFragment:null,constructor:function(){this._iExpectedWrapperCount=0;C.prototype.constructor.apply(this,arguments);this._oDefaultModel=new J({value:this.getValue(),config:this.getConfig(),displayValue:this._formatValue(this.getValue())});this._oDefaultModel.setDefaultBindingMode("OneWay");this.setBindingContext(this._oDefaultModel.getContext("/"));this.setModel(this._oDefaultModel);this.bindProperty("visible","config/visible");this._setReady(false);this._aEditorWrappers=[];this._bInitFinished=false;this.attachBeforeValueChange(function(e){this._iExpectedWrapperCount=this.getExpectedWrapperCount(e.getParameter("nextValue"));},this);this.attachValueChange(function(e){var v=e.getParameter("value");this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{value:v,displayValue:this._formatValue(v)}));this._checkReadyState();},this);this.attachConfigChange(function(e){this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{config:e.getParameter("config")}));},this);this._loadFragment().then(this.asyncInit.bind(this)).then(function(){this._bInitFinished=true;this._checkReadyState();}.bind(this));},renderer:function(r,p){r.openStart("div",p);r.openEnd();if(p.getRenderLabel()&&p.getLabel()){r.openStart("div");r.openEnd();r.renderControl(p.getLabel());r.close("div");}r.renderControl(p.getContent());r.close("div");}});B.prototype.setValue=function(v){var b=this.getValue();var o=this.getConfig()||{};var n=v;if(typeof n==="undefined"&&typeof o.defaultValue!=="undefined"){n=d(o.defaultValue);}if(!a(n,b)){this.fireBeforeValueChange({path:o.path,value:b,nextValue:n});this.setProperty("value",n);this.fireValueChange({path:o.path,previousValue:b,value:n});}};B.prototype._formatValue=function(v){return this.formatValue(d(v));};B.prototype.formatValue=function(v){return v;};B.prototype.getExpectedWrapperCount=function(){return 0;};B.prototype._checkReadyState=function(){if(this._mWrapperReadyCheck){this._mWrapperReadyCheck.cancel();}if(!this._bInitFinished){this._setReady(false);return;}if(this._iExpectedWrapperCount===0){this._setReady(true);return;}if(this._iExpectedWrapperCount===this._aEditorWrappers.length){if(this._aEditorWrappers.every(function(w){return w.isReady();})){this._setReady(true);}else{this._setReady(false);this._mWrapperReadyCheck=c(function(r){Promise.all(this._aEditorWrappers.map(function(w){return w.ready();})).then(r);}.bind(this));this._mWrapperReadyCheck.promise.then(function(){this._setReady(true);delete this._mWrapperReadyCheck;}.bind(this));}}else{this._setReady(false);}};B.prototype.wrapperInit=function(e){var w=e.getSource();if(i(w)){return;}this._aEditorWrappers.push(w);w.attachReady(function(){this._setReady(false);this._checkReadyState();}.bind(this));if(!this._oWrapperObserver){this._oWrapperObserver=new M(function(m){this._aEditorWrappers=this._aEditorWrappers.filter(function(E){return E!==m.object;});}.bind(this));}this._oWrapperObserver.observe(w,{destroy:true});this._checkReadyState();};B.prototype._setReady=function(r){var p=this._bIsReady;this._bIsReady=r;if(p!==true&&r===true){this.fireReady();}};B.prototype.isReady=function(){return!!this._bIsReady;};B.prototype.ready=function(){return new Promise(function(r){if(this.isReady()){r();}else{this.attachEventOnce("ready",r);}}.bind(this));};B.prototype._loadFragment=function(){if(!this.xmlFragment){return Promise.resolve();}return F.load({name:this.xmlFragment,controller:this}).then(function(e){this.setContent(e);}.bind(this));};B.prototype.asyncInit=function(){return Promise.resolve();};B.prototype.clone=function(){this.destroyContent();return C.prototype.clone.apply(this,arguments);};B.prototype.exit=function(){this._oDefaultModel.destroy();if(this._oConfigBinding){this._oConfigBinding.destroy();}if(this._oWrapperObserver){this._oWrapperObserver.destroy();}};B.prototype.setConfig=function(o){var p=this.getConfig();if(!a(p,o)){var n=_({},o);this.setProperty("config",n);this.fireConfigChange({previousConfig:p,config:n});}};B.prototype.getI18nProperty=function(n){return this.getModel("i18n").getProperty(n);};B.prototype.getLabel=function(){var l=this.getAggregation("_label");if(!l){l=new L({text:"{config/label}",design:"Bold"});this.setAggregation("_label",l);}return l;};return B;});

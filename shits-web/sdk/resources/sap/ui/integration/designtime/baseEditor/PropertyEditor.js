/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/integration/designtime/baseEditor/util/findClosestInstance","sap/ui/integration/designtime/baseEditor/util/createPromise","sap/ui/integration/designtime/baseEditor/util/escapeParameter","sap/ui/integration/designtime/baseEditor/propertyEditor/PropertyEditorFactory","sap/base/util/restricted/_merge","sap/base/util/restricted/_omit","sap/base/util/deepEqual"],function(C,f,c,e,P,_,a,d){"use strict";var b="config";var g="propertyName";var h=C.extend("sap.ui.integration.designtime.baseEditor.PropertyEditor",{metadata:{properties:{propertyName:{type:"string"},renderLabel:{type:"boolean"},value:{type:"any"},config:{type:"object"}},aggregations:{propertyEditor:{type:"sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor",multiple:false,visibility:"hidden"}},associations:{editor:{type:"sap.ui.integration.designtime.baseEditor.BaseEditor",multiple:false}},events:{editorChange:{parameters:{previousEditor:{type:"sap.ui.integration.designtime.baseEditor.BaseEditor"},editor:{type:"sap.ui.integration.designtime.baseEditor.BaseEditor"}}},propertyEditorChange:{parameters:{previousPropertyEditor:{type:"sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor"},propertyEditor:{type:"sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor"}}},configChange:{parameters:{previousConfig:{type:"object"},config:{type:"object"}}},propertyNameChange:{parameters:{previousPropertyName:{type:"string"},propertyName:{type:"string"}}},ready:{},beforeValueChange:{parameters:{path:{type:"string"},value:{type:"any"},nextValue:{type:"any"}}},valueChange:{parameters:{path:{type:"string"},value:{type:"any"},previousValue:{type:"any"}}}}},_bEditorAutoDetect:false,_sCreatedBy:null,constructor:function(){C.prototype.constructor.apply(this,e(arguments,"config"));if(!this.getEditor()){this._bEditorAutoDetect=true;}this._propagationListener=this._propagationListener.bind(this);this.attachEditorChange(function(E){if(this._sCreatedBy){this._removePropertyEditor(E.getParameter("previousEditor"));}this._initPropertyEditor();});this.attachConfigChange(function(){this._removePropertyEditor(this.getEditor());this._initPropertyEditor();});this.attachPropertyNameChange(function(){if(this._sCreatedBy===g){this._removePropertyEditor(this.getEditor());}if(this._sCreatedBy!==b){this._initPropertyEditor();}});this._initPropertyEditor();},renderer:function(r,o){r.openStart("div",o);r.openEnd();r.renderControl(o.getAggregation("propertyEditor"));r.close("div");}});h.prototype.getEditor=function(){return sap.ui.getCore().byId(this.getAssociation("editor"));};h.prototype.setConfig=function(m){var p=this.getConfig();if(!d(p,m)){this.setProperty("config",m);this.fireConfigChange({previousConfig:p,config:m});}};h.prototype.setPropertyName=function(p){var s=this.getPropertyName();if(s!==p){this.setProperty("propertyName",p);this.firePropertyNameChange({previousPropertyName:s,propertyName:p});}};h.prototype.setEditor=function(E){var p=this.getEditor();var o=typeof E==="string"?sap.ui.getCore().byId(E):E;if(p!==o){this.setAssociation("editor",E);var o=this.getEditor();this.fireEditorChange({previousEditor:p,editor:o});}};h.prototype.destroy=function(){if(this._fnCancelInit){this._fnCancelInit().then(this._cleanupCancelledInit);}this._removePropertyEditor(this.getEditor());C.prototype.destroy.apply(this,arguments);};h.prototype._cleanupCancelledInit=function(p){p.destroy();};h.prototype._removePropertyEditor=function(E){var p=this.getAggregation("propertyEditor");if(p){this.setAggregation("propertyEditor",null);p.detachReady(this._onPropertyEditorReady,this);p.destroy();this._sCreatedBy=null;this.setValue(undefined);this.firePropertyEditorChange({propertyEditor:null});}if(E&&this._mConfig&&this._isAbsolutePath(this._mConfig.path)){E.deregisterPropertyEditor(this,this._mConfig.__propertyName);}};h.prototype.isReady=function(){var n=this.getAggregation("propertyEditor");return n&&n.isReady()||false;};h.prototype.ready=function(){return new Promise(function(r){var i=function(n){n.ready().then(r);};var n=this.getAggregation("propertyEditor");if(n){i(n);}else{var w=function(E){var n=E.getParameter("propertyEditor");if(n){this.detachPropertyEditorChange(w,this);i(n);}};this.attachPropertyEditorChange(w,this);}}.bind(this));};h.prototype._onPropertyEditorReady=function(){this.fireReady();};h.prototype._initPropertyEditor=function(){if(!this.getEditor()){return;}if(this.getConfig()||(!this.getBindingInfo("config")&&this.getPropertyName()&&this.getEditor())){if(this._fnCancelInit){this._fnCancelInit().then(this._cleanupCancelledInit);delete this._fnCancelInit;}this._mConfig=this.getConfig()||this.getEditor().getPropertyConfigByName(this.getPropertyName());var s=this.getConfig()?b:g;if(this._isAbsolutePath(this._mConfig.path)){this.getEditor().registerPropertyEditor(this,this._mConfig.__propertyName);}var p=c(function(r,R){P.create(this._mConfig.type).then(r).catch(R);}.bind(this));this._fnCancelInit=p.cancel;p.promise.then(function(o){o.setModel(this.getEditor().getModel("i18n"),"i18n");o.setConfig(a(_({},this._mConfig),"__propertyName"));o.addStyleClass("sapUiTinyMargin");o.attachBeforeValueChange(function(E){this.fireBeforeValueChange(a(E.getParameters(),"id"));},this);o.attachValueChange(function(E){this.setValue(E.getParameter("value"));this.fireValueChange(a(E.getParameters(),"id"));},this);o.setValue(this.getValue());this._sCreatedBy=s;this.setAggregation("propertyEditor",o);var r=this.getRenderLabel();if(r!==undefined){o.setRenderLabel(r);}o.attachReady(this._onPropertyEditorReady,this);if(o.isReady()){this.fireReady();}this.firePropertyEditorChange({propertyEditor:o});delete this._fnCancelInit;}.bind(this));}};h.prototype._isAbsolutePath=function(p){return p.startsWith("/");};h.prototype._propagationListener=function(){var E=f(this.getParent(),"sap.ui.integration.designtime.baseEditor.BaseEditor");if(E){this.setEditor(E);this.removePropagationListener(this._propagationListener);}};h.prototype.setParent=function(p){C.prototype.setParent.apply(this,arguments);if(this._bEditorAutoDetect){var E=f(p,"sap.ui.integration.designtime.baseEditor.BaseEditor");if(E){this.setEditor(E);}else{this.addPropagationListener(this._propagationListener);}}};h.prototype.setRenderLabel=function(r){this.setProperty("renderLabel",r);var n=this.getAggregation("propertyEditor");if(n){n.setRenderLabel(r);}};h.prototype.getContent=function(){var n=this.getAggregation("propertyEditor");return n&&n.getContent();};h.prototype.setValue=function(v){this.setProperty("value",v);var n=this.getAggregation("propertyEditor");if(n){n.setValue(v);}};h.prototype.getRuntimeConfig=function(){return this._mConfig;};return h;});

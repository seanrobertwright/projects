/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Manifest","sap/base/util/deepClone","sap/base/util/isPlainObject","sap/base/Log","./ParameterMap","sap/ui/integration/util/CardMerger"],function(B,C,d,a,L,P,b){"use strict";var M="/{SECTION}/configuration/parameters",c="/{SECTION}",A="/sap.app/dataSources";var e=B.extend("sap.ui.integration.util.Manifest",{constructor:function(s,m,i,j){B.call(this);this._aChanges=j;this.PARAMETERS=M.replace("{SECTION}",s);this.CONFIGURATION=c.replace("{SECTION}",s);if(m){var o={},l;o.process=false;if(i){o.baseUrl=i;this._sBaseUrl=i;}else{L.warning("If no base URL is provided when the manifest is an object static resources cannot be loaded.");}if(this._aChanges){l=b.mergeCardDelta(m,this._aChanges);}else{l=m;}this._oManifest=new C(l,o);this.oJson=this._oManifest.getRawJson();}}});e.prototype.getJson=function(){return this._unfreeze(this.oJson);};e.prototype.get=function(s){return this._unfreeze(k(this.oJson,s));};e.prototype.getUrl=function(){return this._oManifest.resolveUri("./","manifest");};e.prototype.getResourceBundle=function(){return this.oResourceBundle;};e.prototype._unfreeze=function(v){if(typeof v==="object"){return JSON.parse(JSON.stringify(v));}return v;};e.prototype.destroy=function(){this.oJson=null;this.oResourceBundle=null;if(this._oManifest){this._oManifest.destroy();}};e.prototype.load=function(s){if(!s||!s.manifestUrl){if(s&&s.processI18n===false){this.processManifest();return new Promise(function(i){i();});}if(this._sBaseUrl&&this._oManifest){return this.loadI18n().then(function(){this.processManifest();}.bind(this));}else{if(this._oManifest){this.processManifest();}return new Promise(function(i){i();});}}return C.load({manifestUrl:s.manifestUrl,async:true,processJson:function(m){if(this._aChanges){return b.mergeCardDelta(m,this._aChanges);}return m;}.bind(this)}).then(function(m){this._oManifest=m;this.oJson=this._oManifest.getRawJson();if(s&&s.processI18n===false){this.processManifest();return new Promise(function(i){i();});}return this.loadI18n().then(function(){this.processManifest();}.bind(this));}.bind(this));};e.prototype.loadI18n=function(){return this._oManifest._loadI18n(true).then(function(o){this.oResourceBundle=o;}.bind(this));};e.prototype.processManifest=function(o){var i=0,m=15,u=jQuery.extend(true,{},this._oManifest.getRawJson()),D=this.get(A);p(u,this.oResourceBundle,i,m,o,D);f(u);this.oJson=u;};function f(o){if(o&&typeof o==='object'&&!Object.isFrozen(o)){Object.freeze(o);for(var K in o){if(o.hasOwnProperty(K)){f(o[K]);}}}}function g(v){return(typeof v==="string")&&v.indexOf("{{")===0&&v.indexOf("}}")===v.length-2;}function h(v){return(typeof v==="string")&&(v.indexOf("{{parameters.")>-1||v.indexOf("{{dataSources")>-1);}e._processPlaceholder=function(s,o,D){var i=P.processPredefinedParameter(s),v,j;if(o){for(var l in o){v=o[l].value;j="{{parameters."+l;i=r(i,v,j);}}if(D){i=r(i,D,"{{dataSources");}return i;};function r(s,v,i){if(a(v)){for(var j in v){s=r(s,v[j],i+"."+j);}}else if(s.includes(i+"}}")){s=s.replace(new RegExp(i+"}}",'g'),v);}return s;}function p(o,R,i,m,j,D){if(i===m){return;}if(Array.isArray(o)){o.forEach(function(I,l,n){if(typeof I==="object"){p(I,R,i+1,m,j,D);}else if(h(I,o,j)){n[l]=e._processPlaceholder(I,j,D);}else if(g(I)&&R){n[l]=R.getText(I.substring(2,I.length-2));}},this);}else{for(var s in o){if(typeof o[s]==="object"){p(o[s],R,i+1,m,j,D);}else if(h(o[s],o,j)){o[s]=e._processPlaceholder(o[s],j,D);}else if(g(o[s])&&R){o[s]=R.getText(o[s].substring(2,o[s].length-2));}}}}function k(o,s){if(o&&s&&typeof s==="string"&&s[0]==="/"){var j=s.substring(1).split("/"),m;for(var i=0,l=j.length;i<l;i++){m=j[i];o=o.hasOwnProperty(m)?o[m]:undefined;if(o===null||typeof o!=="object"){if(i+1<l&&o!==undefined){o=undefined;}break;}}return o;}return o&&o[s];}e.prototype.processParameters=function(o){if(!this._oManifest){return;}var m=this.get(this.PARAMETERS);if(o&&!m){L.error("If parameters property is set, parameters should be described in the manifest");return;}var i=this._syncParameters(o,m);this.processManifest(i);};e.prototype._syncParameters=function(o,m){if(!o){return m;}var l=d(m,20,20),n=Object.getOwnPropertyNames(o),q=Object.getOwnPropertyNames(l);for(var i=0;i<q.length;i++){for(var j=0;j<n.length;j++){if(q[i]===n[j]){l[q[i]].value=o[n[j]];}}}return l;};return e;},true);

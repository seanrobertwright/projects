/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/f/library","sap/ui/dom/includeScript","sap/f/cards/BaseContent","sap/ui/integration/thirdparty/adaptivecards","sap/ui/integration/thirdparty/adaptivecards-templating","sap/f/cards/adaptivecards/elements/UI5InputText","sap/f/cards/adaptivecards/elements/UI5InputNumber","sap/f/cards/adaptivecards/elements/UI5InputChoiceSet","sap/f/cards/adaptivecards/elements/UI5InputTime","sap/f/cards/adaptivecards/elements/UI5InputDate","sap/f/cards/adaptivecards/elements/UI5InputToggle","sap/f/cards/adaptivecards/overwrites/ActionRender","sap/f/cards/adaptivecards/elements/hostConfig","sap/ui/model/json/JSONModel","sap/base/Log"],function(i,l,a,B,A,b,U,c,d,e,f,g,h,H,J,L){"use strict";var j=B.extend("sap.f.cards.AdaptiveContent",{renderer:{apiVersion:2,render:function(r,C){var p=B.getMetadata().getRenderer();return p.render.apply(this,arguments);}}});j.prototype.init=function(){this._bComponentsReady=false;this._bAdaptiveCardElementsReady=false;this._setupAdaptiveCardDependency();this._loadDependencies();};j.prototype.setConfiguration=function(C){this._oCardConfig=C;if(C&&C.request&&C.request.url){this._loadManifestFromUrl(C.request.url);return;}this._setupMSCardContent();};j.prototype._loadManifestFromUrl=function(u){var D=new J(),t=this;D.loadData(u).then(function(){t._oCardConfig=D.getData();t._setupMSCardContent();}).then(function(){D.destroy();D=null;}).catch(function(){L.error("No JSON file found on this URL. Please provide a correct path to the JSON-serialized card object model file.");});};j.prototype.onAfterRendering=function(){this._setupMSCardContent();};j.prototype._setupAdaptiveCardDependency=function(){this.adaptiveCardInstance=new A.AdaptiveCard();this._doMSCardsOverwrites();this._adjustHostConfig();this._handleActions();this._replaceElements();this._isRtl();};j.prototype._doMSCardsOverwrites=function(){A.Action.prototype.render=h;};j.prototype._adjustHostConfig=function(){this.adaptiveCardInstance.hostConfig=new A.HostConfig(H);};j.prototype._isRtl=function(){this.adaptiveCardInstance.isRtl=function(){return sap.ui.getCore().getConfiguration().getRTL();};};j.prototype._handleActions=function(){this.adaptiveCardInstance.onExecuteAction=function(o){var t,p,C;if(o instanceof A.OpenUrlAction){p={url:o.url};t=i.CardActionType.Navigation;}else if(o instanceof A.SubmitAction){p=o.data;t=i.CardActionType.Submit;}else{return;}C=this.getActions();if(C){C.fireAction(this,t,p);}}.bind(this);};j.prototype._replaceElements=function(){A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Text");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Text",function(){return new U();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Number");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Number",function(){return new c();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.ChoiceSet");A.AdaptiveCard.elementTypeRegistry.registerType("Input.ChoiceSet",function(){return new d();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Time");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Time",function(){return new e();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Date");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Date",function(){return new f();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Toggle");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Toggle",function(){return new g();});};j.prototype._setupMSCardContent=function(){var D=this.$(),C=this._oCardConfig,t;if(!this.adaptiveCardInstance||!C||!(D&&D.size())){return;}t=C.$data||C.data;if(!t){this._renderMSCardContent(C);return;}if(C.$data){t={"json":t};}this._setData(t);};j.prototype._setData=function(D){var C,m,o,p="";if(D&&D.path){p=D.path;}if(this._oDataProvider){this._oDataProvider.destroy();}if(this._oDataProviderFactory){this._oDataProvider=this._oDataProviderFactory.create(D,this._oServiceManager);}if(this._oDataProvider){this.setBusy(true);m=this.setModel(new J());this._oDataProvider.attachDataChanged(function(E){o=E.getParameter('data');this._updateModel(o);if(p.length){o=m.getProperty(p);}C=this._setTemplating(this._oCardConfig,o);C&&this._renderMSCardContent(C);this.setBusy(false);}.bind(this));this._oDataProvider.attachError(function(E){this._handleError(E.getParameter("message"));this.setBusy(false);}.bind(this));this._oDataProvider.triggerDataUpdate().then(function(){this.fireEvent("_dataReady");}.bind(this));}else{this.fireEvent("_dataReady");}};j.prototype._renderMSCardContent=function(C){var D=this.$();if(this.adaptiveCardInstance&&C&&D&&D.size()){this.adaptiveCardInstance.parse(C);D.html(this.adaptiveCardInstance.render());this._bAdaptiveCardElementsReady=true;this._fireCardReadyEvent();}};j.prototype._fireCardReadyEvent=function(){if(this._bAdaptiveCardElementsReady&&this._bComponentsReady){this._bReady=true;this.fireEvent("_ready");}};j.prototype._setTemplating=function(t,D){var C=new b.Template(t),o=new b.EvaluationContext();o.$root=D;return C.expand(o);};j.prototype._loadDependencies=function(){if(document.querySelector("#webcomponents-loader")){this._bComponentsReady=true;this._fireCardReadyEvent();return;}a({id:"webcomponents-loader",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/webcomponentsjs/webcomponents-loader.js")});document.addEventListener("WebComponentsReady",function(){a({id:"webcomponents-bundle",attributes:{type:"module"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.esm.js")});a({id:"webcomponents-bundle-es5",attributes:{nomodule:"nomodule"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.es5.js")});this._bComponentsReady=true;this._fireCardReadyEvent();}.bind(this));};return j;});

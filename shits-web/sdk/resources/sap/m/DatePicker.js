/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/Device','./InputBase','./DateTimeField','./Button','./ResponsivePopover','sap/ui/core/date/UniversalDate','./library','sap/ui/core/Control','sap/ui/core/library',"./DatePickerRenderer","sap/base/util/deepEqual","sap/base/assert","sap/base/Log","sap/ui/core/IconPool","./InstanceManager","sap/ui/unified/Calendar","sap/ui/unified/DateRange","sap/ui/unified/calendar/CustomMonthPicker","sap/ui/unified/calendar/CustomYearPicker","sap/ui/dom/jquery/cursorPos"],function(q,D,I,a,B,R,U,l,C,c,b,d,e,L,f,g,h,i,j,k){"use strict";var m=c.CalendarType;var r=sap.ui.getCore().getLibraryResourceBundle("sap.m");var n=a.extend("sap.m.DatePicker",{metadata:{library:"sap.m",properties:{displayFormatType:{type:"string",group:"Appearance",defaultValue:""},secondaryCalendarType:{type:"sap.ui.core.CalendarType",group:"Appearance",defaultValue:null},minDate:{type:"object",group:"Misc",defaultValue:null},maxDate:{type:"object",group:"Misc",defaultValue:null},showFooter:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{specialDates:{type:"sap.ui.core.Element",multiple:true,singularName:"specialDate"},_popup:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},associations:{legend:{type:"sap.ui.core.Control",multiple:false}},events:{navigate:{parameters:{dateRange:{type:"sap.ui.unified.DateRange"},afterPopupOpened:{type:"boolean"}}}},designtime:"sap/m/designtime/DatePicker.designtime",dnd:{draggable:false,droppable:true}}});n.prototype.init=function(){a.prototype.init.apply(this,arguments);this._bIntervalSelection=false;this._bOnlyCalendar=true;this._bValid=true;this._oMinDate=new Date(1,0,1);this._oMinDate.setFullYear(1);this._oMaxDate=new Date(9999,11,31,23,59,59,999);var w=this.addEndIcon({id:this.getId()+"-icon",src:this.getIconSrc(),noTabStop:true,tooltip:r.getText("OPEN_PICKER_TEXT")});this._bShouldClosePicker=false;w.addEventDelegate({onmousedown:function(E){this._bShouldClosePicker=!!this.isOpen();}},this);w.attachPress(function(){this.toggleOpen(this._bShouldClosePicker);},this);};n.prototype.isValidValue=function(){return this._bValid;};n.prototype.isOpen=function(){return this._oPopup&&this._oPopup.isOpen();};n.prototype.toggleOpen=function(O){if(this.getEditable()&&this.getEnabled()){if(O){o.call(this);}else{_.call(this);}}};n.prototype.getIconSrc=function(){return f.getIconURI("appointment-2");};n.prototype.exit=function(){I.prototype.exit.apply(this,arguments);if(this._oPopup){if(this._oPopup.isOpen()){this._oPopup.close();}delete this._oPopup;}if(this._getCalendar()){this._getCalendar().destroy();delete this._getCalendar();}if(this._iInvalidateCalendar){clearTimeout(this._iInvalidateCalendar);}this._sUsedDisplayPattern=undefined;this._sUsedDisplayCalendarType=undefined;this._oDisplayFormat=undefined;this._sUsedValuePattern=undefined;this._sUsedValueCalendarType=undefined;this._oValueFormat=undefined;};n.prototype.invalidate=function(O){if(!O||O!=this._getCalendar()){C.prototype.invalidate.apply(this,arguments);this._iInvalidateCalendar=setTimeout(v.bind(this),0);}};n.prototype.onBeforeRendering=function(){a.prototype.onBeforeRendering.apply(this,arguments);this._checkMinMaxDate();var V=this._getValueHelpIcon();if(V){V.setProperty("visible",this.getEditable(),true);}};n.prototype.setWidth=function(w){return I.prototype.setWidth.call(this,w||"100%");};n.prototype.getWidth=function(w){return this.getProperty("width")||"100%";};n.prototype.applyFocusInfo=function(F){this._bFocusNoPopup=true;if(!D.support.touch||D.system.desktop){I.prototype.applyFocusInfo.apply(this,arguments);}};n.prototype.onfocusin=function(E){if(!q(E.target).hasClass("sapUiIcon")){I.prototype.onfocusin.apply(this,arguments);}this._bFocusNoPopup=undefined;};n.prototype.onsapshow=function(E){this.toggleOpen(this.isOpen());E.preventDefault();};n.prototype.onsaphide=n.prototype.onsapshow;n.prototype.onsappageup=function(E){var w=this._getCalendarConstructor().getMetadata().getName();E.preventDefault();if(w!="sap.ui.unified.Calendar"){return;}this._increaseDate(1,"day");};n.prototype.onsappageupmodifiers=function(E){var w=this._getCalendarConstructor().getMetadata().getName();E.preventDefault();if(!E.ctrlKey&&E.shiftKey){if(w=="sap.ui.unified.internal.CustomYearPicker"){return;}this._increaseDate(1,"month");}else{this._increaseDate(1,"year");}};n.prototype.onsappagedown=function(E){var w=this._getCalendarConstructor().getMetadata().getName();E.preventDefault();if(w!="sap.ui.unified.Calendar"){return;}this._increaseDate(-1,"day");};n.prototype.onsappagedownmodifiers=function(E){var w=this._getCalendarConstructor().getMetadata().getName();E.preventDefault();if(!E.ctrlKey&&E.shiftKey){if(w=="sap.ui.unified.internal.CustomYearPicker"){return;}this._increaseDate(-1,"month");}else{this._increaseDate(-1,"year");}};n.prototype.onkeypress=function(E){if(!E.charCode||E.metaKey||E.ctrlKey){return;}var F=this._getFormatter(true);var w=String.fromCharCode(E.charCode);if(w&&F.sAllowedCharacters&&F.sAllowedCharacters.indexOf(w)<0){E.preventDefault();}};n.prototype._getValueHelpIcon=function(){var V=this.getAggregation("_endIcon");return V&&V[0];};n.prototype._dateValidation=function(w){this._bValid=true;if(w&&(w.getTime()<this._oMinDate.getTime()||w.getTime()>this._oMaxDate.getTime())){this._bValid=false;e(this._bValid,"Date must be in valid range");}this.setProperty("dateValue",w);return w;};n.prototype.setMinDate=function(w){if(this._isValidDate(w)){throw new Error("Date must be a JavaScript date object; "+this);}if(d(this.getMinDate(),w)){return this;}if(w){var y=w.getFullYear();if(y<1||y>9999){throw new Error("Date must be between 0001-01-01 and 9999-12-31; "+this);}this._oMinDate=new Date(w.getTime());var x=this.getDateValue();if(x&&x.getTime()<w.getTime()){this._bValid=false;L.warning("DateValue not in valid date range",this);}}else{this._oMinDate=new Date(1,0,1);this._oMinDate.setFullYear(1);}this.setProperty("minDate",w);if(this._getCalendar()){this._getCalendar().setMinDate(w);}this._oMinDate.setHours(0,0,0,0);return this;};n.prototype.setMaxDate=function(w){if(this._isValidDate(w)){throw new Error("Date must be a JavaScript date object; "+this);}if(d(this.getMaxDate(),w)){return this;}if(w){var y=w.getFullYear();if(y<1||y>9999){throw new Error("Date must be between 0001-01-01 and 9999-12-31; "+this);}this._oMaxDate=new Date(w.getTime());var x=this.getDateValue();if(x&&x.getTime()>w.getTime()){this._bValid=false;L.warning("DateValue not in valid date",this);}}else{this._oMaxDate=new Date(9999,11,31,23,59,59,999);}this.setProperty("maxDate",w);if(this._getCalendar()){this._getCalendar().setMaxDate(w);}this._oMaxDate.setHours(23,59,59,999);return this;};n.prototype._checkMinMaxDate=function(){if(this._oMinDate.getTime()>this._oMaxDate.getTime()){L.warning("minDate > MaxDate -> dates switched",this);var M=new Date(this._oMinDate.getTime());var w=new Date(this._oMaxDate.getTime());this._oMinDate=new Date(w.getTime());this._oMaxDate=new Date(M.getTime());this.setProperty("minDate",w,true);this.setProperty("maxDate",M,true);if(this._getCalendar()){this._getCalendar().setMinDate(w);this._getCalendar().setMaxDate(M);}}var x=this.getDateValue();if(x&&(x.getTime()<this._oMinDate.getTime()||x.getTime()>this._oMaxDate.getTime())){this._bValid=false;L.error("dateValue "+x.toString()+"(value="+this.getValue()+") does not match "+"min/max date range("+this._oMinDate.toString()+" - "+this._oMaxDate.toString()+"). App. "+"developers should take care to maintain dateValue/value accordingly.",this);}};n.prototype.getDisplayFormatType=function(){return this.getProperty("displayFormatType");};n.prototype._handleDateValidation=function(w){this._bValid=true;if(!w||w.getTime()<this._oMinDate.getTime()||w.getTime()>this._oMaxDate.getTime()){this._bValid=false;L.warning("Value can not be converted to a valid date",this);}var V=this._formatValue(w,true);if(V!==this.getValue()){this._lastValue=V;}this.setProperty("value",V);this.setProperty("dateValue",w);};n.prototype.setDisplayFormatType=function(w){if(w){var F=false;for(var T in m){if(T==w){F=true;break;}}if(!F){throw new Error(w+" is not a valid calendar type"+this);}}this.setProperty("displayFormatType",w,true);this.setDisplayFormat(this.getDisplayFormat());return this;};n.prototype.setSecondaryCalendarType=function(w){this._bSecondaryCalendarTypeSet=true;this.setProperty("secondaryCalendarType",w,true);if(this._getCalendar()){this._getCalendar().setSecondaryCalendarType(w);}return this;};n.prototype.setShowFooter=function(F){var P=this._oPopup,w=this._getCalendar();this.setProperty("showFooter",F);if(!P||!w){return this;}P._getButtonFooter().setVisible(F);return this;};n.prototype.addSpecialDate=function(S){u.call(this,S);this.addAggregation("specialDates",S,true);v.call(this);return this;};n.prototype.insertSpecialDate=function(S,w){u.call(this,S);this.insertAggregation("specialDates",S,w,true);v.call(this);return this;};n.prototype.removeSpecialDate=function(S){var w=this.removeAggregation("specialDates",S,true);v.call(this);return w;};n.prototype.removeAllSpecialDates=function(){var w=this.removeAllAggregation("specialDates",true);v.call(this);return w;};n.prototype.destroySpecialDates=function(){this.destroyAggregation("specialDates",true);v.call(this);return this;};n.prototype.setLegend=function(w){this.setAssociation("legend",w,true);var x=this.getLegend();if(x){var y=sap.ui.require("sap/ui/unified/CalendarLegend");w=sap.ui.getCore().byId(x);if(w&&!(typeof y=="function"&&w instanceof y)){throw new Error(w+" is not an sap.ui.unified.CalendarLegend. "+this);}}if(this._getCalendar()){this._getCalendar().setLegend(x);}return this;};n.prototype.onChange=function(E){if(!this.getEditable()||!this.getEnabled()){return;}var V=this._$input.val(),O=this._formatValue(this.getDateValue()),w;if(V==O&&this._bValid){return;}if(this.getShowFooter()&&this._oPopup&&!V){this._oPopup.getBeginButton().setEnabled(false);}this._bValid=true;if(V!=""){w=this._parseValue(V,true);if(!w||w.getTime()<this._oMinDate.getTime()||w.getTime()>this._oMaxDate.getTime()){this._bValid=false;w=undefined;}else{V=this._formatValue(w);}}if(this.getDomRef()&&(this._$input.val()!==V)){this._$input.val(V);this._curpos=this._$input.cursorPos();}if(w){V=this._formatValue(w,true);}if(this._lastValue!==V||(w&&this.getDateValue()&&w.getFullYear()!==this.getDateValue().getFullYear())){this._lastValue=V;this.setProperty("value",V,true);var N=this.getValue();if(this._bValid&&V==N){this.setProperty("dateValue",w,true);}V=N;if(this.isOpen()){if(this._bValid){w=this.getDateValue();}this._getCalendar().focusDate(w);var S=this._oDateRange.getStartDate();if((!S&&w)||(S&&w&&S.getTime()!=w.getTime())){this._oDateRange.setStartDate(new Date(w.getTime()));}else if(S&&!w){this._oDateRange.setStartDate(undefined);}}this.fireChangeEvent(V,{valid:this._bValid});}};n.prototype._getInputValue=function(V){V=(typeof V=="undefined")?this._$input.val():V.toString();var w=this._parseValue(V,true);V=this._formatValue(w,true);return V;};n.prototype.updateDomValue=function(V){if(this.isActive()&&(this._$input.val()!==V)){this._bCheckDomValue=true;V=(typeof V=="undefined")?this._$input.val():V.toString();this._curpos=this._$input.cursorPos();var w=this._parseValue(V,true);V=this._formatValue(w);this._$input.val(V);if(document.activeElement===this._$input[0]){this._$input.cursorPos(this._curpos);}}return this;};n.prototype._storeInputSelection=function(w){if((D.browser.msie||D.browser.edge)&&!D.support.touch){this._oInputSelBeforePopupOpen={iStart:w.selectionStart,iEnd:w.selectionEnd};w.selectionStart=0;w.selectionEnd=0;}};n.prototype._restoreInputSelection=function(w){if((D.browser.msie||D.browser.edge)&&!D.support.touch){w.selectionStart=this._oInputSelBeforePopupOpen.iStart;w.selectionEnd=this._oInputSelBeforePopupOpen.iEnd;}};function _(){this._createPopup();this._createPopupContent();var w;var x=this.getBinding("value");if(x&&x.oType&&x.oType.oOutputFormat){w=x.oType.oOutputFormat.oFormatOptions.calendarType;}else if(x&&x.oType&&x.oType.oFormat){w=x.oType.oFormat.oFormatOptions.calendarType;}if(!w){w=this.getDisplayFormatType();}if(w){this._getCalendar().setPrimaryCalendarType(w);}var V=this._bValid?this._formatValue(this.getDateValue()):this.getValue();if(V!=this._$input.val()){this.onChange();}this._fillDateRange();this._openPopup();this.fireNavigate({dateRange:this._getVisibleDatesRange(this._getCalendar()),afterPopupOpened:true});}n.prototype._createPopup=function(){var A,w;if(!this._oPopup){this._oPopup=new R(this.getId()+"-RP",{showCloseButton:false,showArrow:false,showHeader:false,placement:l.PlacementType.VerticalPreferedBottom}).addStyleClass("sapMRPCalendar");this._oPopup._getPopup().setAutoClose(true);this._oPopup.attachAfterOpen(p,this);this._oPopup.attachAfterClose(s,this);this._oPopup.setBeginButton(new B({text:r.getText("DATEPICKER_SELECTION_CONFIRM"),press:this._handleOKButton.bind(this)}));if(D.system.phone){A=this.$("inner").attr("aria-labelledby");w=A?document.getElementById(A).getAttribute("aria-label"):"";this._oPopup.setTitle(w);this._oPopup.setShowHeader(true);this._oPopup.setShowCloseButton(true);}else{this._oPopup._getPopup().setDurations(0,0);this._oPopup.getBeginButton().setType(l.ButtonType.Emphasized);this._oPopup.setEndButton(new B({text:r.getText("DATEPICKER_SELECTION_CANCEL"),press:this._handleCancelButton.bind(this)}));}this.setAggregation("_popup",this._oPopup,true);}};n.prototype._openPopup=function(){if(!this._oPopup){return;}this._storeInputSelection(this._$input.get(0));this._oPopup._getPopup().setAutoCloseAreas([this.getDomRef()]);this._oPopup.openBy(this);};n.prototype._getVisibleDatesRange=function(w){var V=w._getVisibleDays();return new i({startDate:V[0].toLocalJSDate(),endDate:V[V.length-1].toLocalJSDate()});};n.prototype._createPopupContent=function(){var w=this._getCalendarConstructor();if(!this._getCalendar()){this._oCalendar=new w(this.getId()+"-cal",{intervalSelection:this._bIntervalSelection,minDate:this.getMinDate(),maxDate:this.getMaxDate(),legend:this.getLegend(),startDateChange:function(){this.fireNavigate({dateRange:this._getVisibleDatesRange(this._getCalendar())});}.bind(this)});this._oDateRange=new i();this._getCalendar().addSelectedDate(this._oDateRange);this._getCalendar()._setSpecialDatesControlOrigin(this);if(this.$().closest(".sapUiSizeCompact").length>0){this._getCalendar().addStyleClass("sapUiSizeCompact");}if(this._bSecondaryCalendarTypeSet){this._getCalendar().setSecondaryCalendarType(this.getSecondaryCalendarType());}if(this._bOnlyCalendar){this._getCalendar().attachSelect(this._handleCalendarSelect,this);this._getCalendar().attachCancel(o,this);this._getCalendar().attachEvent("_renderMonth",t,this);this._oCalendar.setPopupMode(true);this._oPopup._getButtonFooter().setVisible(this.getShowFooter());this._getCalendar()._bSkipCancelButtonRendering=true;this._oPopup.addContent(this._getCalendar());if(!this.getDateValue()){this._oPopup.getBeginButton().setEnabled(false);}}}};n.prototype._getCalendarConstructor=function(){var P=this._getFormatter(true).aFormatArray.map(function(x){return x.type.toLowerCase();}),w=P.indexOf("day")>=0,M=P.indexOf("month")>=0,y=P.indexOf("year")>=0;if(w&&M&&y){return h;}else if(M&&y){return j;}else if(y){return k;}else{L.warning("Not valid date pattern! Default Calendar constructor function is returned",this);return h;}};n.prototype._fillDateRange=function(){var w=this.getDateValue();if(w&&w.getTime()>=this._oMinDate.getTime()&&w.getTime()<=this._oMaxDate.getTime()){this._getCalendar().focusDate(new Date(w.getTime()));if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!=w.getTime()){this._oDateRange.setStartDate(new Date(w.getTime()));}}else{var x=this.getInitialFocusedDateValue();var F=x?x:new Date();var M=this._oMaxDate.getTime();if(F.getTime()<this._oMinDate.getTime()||F.getTime()>M){F=this._oMinDate;}this._getCalendar().focusDate(F);if(this._oDateRange.getStartDate()){this._oDateRange.setStartDate(undefined);}}};n.prototype.getAccessibilityInfo=function(){var w=this.getRenderer();var x=I.prototype.getAccessibilityInfo.apply(this,arguments);var V=this.getValue()||"";if(this._bValid){var y=this.getDateValue();if(y){V=this._formatValue(y);}}x.type=r.getText("ACC_CTR_TYPE_DATEINPUT");x.description=[V,w.getLabelledByAnnouncement(this),w.getDescribedByAnnouncement(this)].join(" ").trim();return x;};n.prototype._selectDate=function(){var w=this.getDateValue(),x=this._getSelectedDate(),V="";if(!d(x,w)){this.setDateValue(new Date(x.getTime()));V=this.getValue();this.fireChangeEvent(V,{valid:true});this._focusInput();}else if(!this._bValid){V=this._formatValue(x);if(V!=this._$input.val()){this._bValid=true;if(this.getDomRef()){this._$input.val(V);this._lastValue=V;}V=this._formatValue(x,true);this.setProperty("value",V,true);this.fireChangeEvent(V,{valid:true});this._focusInput();}}else if(D.system.desktop||!D.support.touch){this.focus();}this._oPopup.close();};n.prototype._handleCalendarSelect=function(){if(this.getShowFooter()){this._oPopup.getBeginButton().setEnabled(true);return;}this._selectDate();};n.prototype._focusInput=function(){if(this.getDomRef()&&(D.system.desktop||!D.support.touch)){this._curpos=this._$input.val().length;this._$input.cursorPos(this._curpos);}return this;};n.prototype._getCalendar=function(){return this._oCalendar;};n.prototype._getSelectedDate=function(){var S=this._getCalendar().getSelectedDates(),w;if(S.length>0){w=S[0].getStartDate();}return w;};n.prototype._handleOKButton=function(){this._selectDate();};n.prototype._handleCancelButton=function(){if(!this.getDateValue()){this._oPopup.getBeginButton().setEnabled(false);}this._oPopup.close();};function o(E){if(this.isOpen()){this._oPopup.close();if((D.system.desktop||!D.support.touch)){this.focus();}}}n.prototype._increaseDate=function(N,w){var O=this.getDateValue();var x=this._$input.cursorPos();if(O&&this.getEditable()&&this.getEnabled()){var y;var z=this.getBinding("value");if(z&&z.oType&&z.oType.oOutputFormat){y=z.oType.oOutputFormat.oFormatOptions.calendarType;}else if(z&&z.oType&&z.oType.oFormat){y=z.oType.oFormat.oFormatOptions.calendarType;}if(!y){y=this.getDisplayFormatType();}var A=U.getInstance(new Date(O.getTime()),y);O=U.getInstance(new Date(O.getTime()),y);switch(w){case"day":A.setDate(A.getDate()+N);break;case"month":A.setMonth(A.getMonth()+N);var M=(O.getMonth()+N)%12;if(M<0){M=12+M;}while(A.getMonth()!=M){A.setDate(A.getDate()-1);}break;case"year":A.setFullYear(A.getFullYear()+N);while(A.getMonth()!=O.getMonth()){A.setDate(A.getDate()-1);}break;default:break;}if(A.getTime()<this._oMinDate.getTime()){A=new U(this._oMinDate.getTime());}else if(A.getTime()>this._oMaxDate.getTime()){A=new U(this._oMaxDate.getTime());}if(!d(this.getDateValue(),A.getJSDate())){this.setDateValue(new Date(A.getTime()));this._curpos=x;this._$input.cursorPos(this._curpos);var V=this.getValue();this.fireChangeEvent(V,{valid:true});}}};function p(){this.addStyleClass(I.ICON_PRESSED_CSS_CLASS);this._renderedDays=this._getCalendar().$("-Month0-days").find(".sapUiCalItem").length;this.$("inner").attr("aria-owns",this.getId()+"-cal");this.$("inner").attr("aria-expanded",true);g.addPopoverInstance(this._oPopup);this._getCalendar().focus();}function s(){if(!this.getDateValue()){this._oPopup.getBeginButton().setEnabled(false);}this.removeStyleClass(I.ICON_PRESSED_CSS_CLASS);this.$("inner").attr("aria-expanded",false);this._restoreInputSelection(this._$input.get(0));this._getCalendar()._closedPickers();g.removePopoverInstance(this._oPopup);}function t(E){var w=E.getParameter("days"),P=this._oPopup._getPopup();if(w>this._renderedDays){this._renderedDays=w;P._applyPosition(P._oLastPosition);}}function u(S){var w=sap.ui.require("sap/ui/unified/DateTypeRange");if(S&&!(w&&S instanceof w)){throw new Error(S+"is not valid for aggregation \"specialDates\" of "+this);}}function v(){if(this.isOpen()){this._getCalendar()._bDateRangeChanged=false;this._getCalendar().invalidate();}}return n;});
